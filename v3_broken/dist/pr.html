<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Omni - Pull Request</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg-primary: #0a0a0a;
      --bg-secondary: #09090b;
      --bg-tertiary: #141414;
      --bg-hover: #1a1a1a;
      --kbd-bg: rgba(255,255,255,0.05);
      --border: #27272a;
      --border-light: #3f3f46;
      --text-primary: #fafafa;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --accent: #fafafa;
      --accent-dim: rgba(255,255,255,0.08);
      --green: #22c55e;
      --amber: #f59e0b;
      --orange: #fb923c;
      --red: #ef4444;
      --shadow: 0 25px 50px -12px rgba(0,0,0,0.65);
      --mono: 'JetBrains Mono', ui-monospace, monospace;
      --sans: 'Inter', ui-sans-serif, system-ui, sans-serif;
      --radius: 10px;
    }

    html, body { height: 100%; }
    body {
      background: radial-gradient(1100px 700px at 70% 20%, rgba(255,255,255,0.04), transparent 60%),
                  radial-gradient(900px 650px at 15% 75%, rgba(34,197,94,0.04), transparent 62%),
                  linear-gradient(180deg, #000, #0a0a0a);
      color: var(--text-primary);
      font-family: var(--sans);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: hidden;
    }

    /* Scanlines CRT effect */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      pointer-events: none;
      background: repeating-linear-gradient(to bottom, rgba(255,255,255,0.012), rgba(255,255,255,0.012) 1px, rgba(0,0,0,0) 3px, rgba(0,0,0,0) 6px);
      mix-blend-mode: overlay;
      opacity: 0.18;
      z-index: 9999;
    }

    ::selection { background: rgba(255,255,255,0.2); }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #52525b; }

    /* Main Window */
    .window {
      width: 100%;
      max-width: 1100px;
      height: min(680px, calc(100vh - 60px));
      background: rgba(9,9,11,0.88);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      backdrop-filter: blur(12px);
    }

    /* Status Bar (macOS style) */
    .status-bar {
      height: 44px;
      padding: 0 14px;
      border-bottom: 1px solid var(--border);
      background: rgba(0,0,0,0.35);
      display: flex;
      align-items: center;
      flex-shrink: 0;
    }

    .traffic-lights {
      display: flex;
      gap: 8px;
    }

    .traffic-light {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    .traffic-light.red { background: #ff5f57; }
    .traffic-light.yellow { background: #febc2e; }
    .traffic-light.green { background: #28c840; }
    .traffic-light:hover { filter: brightness(1.15); transform: scale(1.1); }
    .traffic-light::after {
      content: '';
      position: absolute;
      inset: 3px;
      border-radius: 50%;
      background: rgba(0,0,0,0.15);
      opacity: 0;
      transition: opacity 0.2s;
    }
    .traffic-light:hover::after { opacity: 1; }

    .status-title {
      flex: 1;
      text-align: center;
      font-size: 13px;
      font-family: var(--mono);
      color: var(--text-muted);
      letter-spacing: 0.02em;
    }

    .status-spacer { width: 52px; }

    /* Buttons */
    .btn {
      font-family: var(--sans);
      font-size: 13px;
      font-weight: 500;
      padding: 8px 14px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.22);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.15s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select: none;
    }
    .btn:hover { background: var(--bg-hover); border-color: var(--border-light); }
    .btn:active { transform: translateY(1px); }
    .btn:disabled, .btn[aria-disabled="true"] {
      opacity: 0.45;
      cursor: not-allowed;
      pointer-events: none;
    }

    .btn-primary {
      background: var(--text-primary);
      color: var(--bg-primary);
      border-color: transparent;
    }
    .btn-primary:hover { background: #e4e4e7; }

    .btn-ghost {
      background: transparent;
      border-color: transparent;
    }
    .btn-ghost:hover { background: var(--accent-dim); border-color: var(--border); }

    .btn .icon {
      width: 14px;
      height: 14px;
      opacity: 0.7;
    }

    .btn .chevron {
      width: 12px;
      height: 12px;
      opacity: 0.5;
      margin-left: auto;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* Left Sidebar */
    .sidebar {
      width: 280px;
      border-right: 1px solid var(--border);
      background: rgba(0,0,0,0.16);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow: hidden;
    }

    .sidebar-section {
      padding: 12px;
      border-bottom: 1px solid rgba(39,39,42,0.5);
    }

    .sidebar-section:first-child {
      padding-top: 14px;
    }

    .sidebar-section:last-child { border-bottom: none; }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .section-header .label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .section-header .meta {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-muted);
    }

    /* PR Item */
    .pr-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 6px 8px;
      border-radius: 6px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text-secondary);
      transition: background 0.15s;
      cursor: pointer;
    }
    .pr-item:hover { background: var(--accent-dim); }
    .pr-item.active { background: var(--accent-dim); }

    .pr-number {
      flex-shrink: 0;
    }

    .pr-status {
      font-size: 11px;
      font-weight: 500;
      white-space: nowrap;
    }

    .pr-status.mergeable {
      color: var(--green);
    }

    /* File List */
    .file-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 8px;
      border-radius: 6px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text-secondary);
      transition: background 0.15s;
      cursor: pointer;
    }
    .file-item:hover { background: var(--bg-hover); }
    .file-item.active { background: var(--accent-dim); }

    /* Commit detail file items use same styling as file stats */
    .detail-files-grid .file-item {
      background: var(--bg-tertiary);
      text-transform: none;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-muted);
      opacity: 0.8;
    }

    /* NEW: Header layout styles */
    .detail-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .detail-header-buttons {
      display: flex;
      gap: 8px;
    }

    .detail-header-btn {
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .detail-header-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
      border-color: var(--border-light);
    }

    .detail-header-subtitle {
      font-size: 12px;
      font-weight: 400;
      color: var(--text-muted);
      font-family: var(--mono);
    }

    /* Inline SHA + copy icon inside commit header subtitle */
    .commit-sha-inline {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .sha-copy-btn {
      width: 18px;
      height: 18px;
      padding: 0;
      border: 1px solid transparent;
      border-radius: 4px;
      background: transparent;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .sha-copy-btn:hover {
      background: var(--accent-dim);
      border-color: var(--border);
      color: var(--text-primary);
    }

    .sha-copy-btn svg {
      width: 12px;
      height: 12px;
      opacity: 0.75;
    }

    /* NEW: Multi-line subtitle support */
    .detail-header-subtitle-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .detail-header-subtitle-row {
      font-size: 12px;
      font-weight: 400;
      color: var(--text-muted);
      font-family: var(--mono);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* UPDATED: Files header layout to support flex */
    .detail-files-header {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 10px;
      display: flex; /* Added flex */
      align-items: center;
      justify-content: space-between; /* Spacing */
    }

    /* NEW: File stats styles */
    .detail-files-stats {
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 500;
      color: var(--text-muted);
      opacity: 0.7;
      text-transform: none;
      letter-spacing: normal;
      display: flex;
      gap: 12px;
    }

    /* Ensure all spans inside file stats use mono font */
    .detail-files-stats span {
      font-family: var(--mono);
    }

    .file-status {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .file-status.M { background: rgba(245,158,11,0.18); color: var(--amber); }
    .file-status.A { background: rgba(34,197,94,0.18); color: var(--green); }
    .file-status.R { background: rgba(239,68,68,0.18); color: var(--red); }

    .file-path {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .file-changes {
      font-size: 10px;
      color: var(--text-muted);
      white-space: nowrap;
    }
    .file-changes .add { color: var(--green); }
    .file-changes .rem { color: var(--red); }

    /* Commit List */
    .commit-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-secondary);
      transition: background 0.15s;
      cursor: pointer;
    }
    .commit-item:hover { background: var(--accent-dim); }
    .commit-item.active { background: var(--accent-dim); }

    .commit-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #ffffff;
      margin-top: 5px;
      flex-shrink: 0;
    }

    .commit-msg {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: var(--mono);
    }

    .empty-state {
      padding: 16px 12px;
      text-align: center;
      font-size: 12px;
      color: var(--text-muted);
      font-style: italic;
    }

    /* Details Panel */
    .details-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      background: rgba(0,0,0,0.08);
    }

    /* Top Bar - Now in Details Panel */
    .top-bar {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: rgba(0,0,0,0.18);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      flex-shrink: 0;
    }

    .top-bar.hidden {
      display: none;
    }

    .details-content-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      overflow-y: auto;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group.flex-grow {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      background: rgba(0,0,0,0.25);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 14px;
      font-family: var(--sans);
      font-size: 13px;
      color: var(--text-primary);
      transition: border-color 0.2s;
    }
    .form-input:focus { outline: none; border-color: var(--border-light); }

    /* Kbd - using system fonts for better symbol support */
    .kbd {
      padding: 2px 6px;
      background: var(--kbd-bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "JetBrains Mono", monospace;
      color: var(--text-secondary);
      display: inline-block;
      vertical-align: baseline;
      transition: background 0.3s ease, border-color 0.2s ease, color 0.2s ease;
    }

    .form-input::placeholder { color: var(--text-muted); }

    textarea.form-input {
      flex: 1;
      min-height: 140px;
      resize: none;
      font-family: var(--mono);
      line-height: 1.6;
    }

    /* Detail Views */
    .detail-view {
      display: none;
      flex-direction: column;
      height: 100%;
    }

    .detail-view.active {
      display: flex;
    }

    .detail-view-header {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .detail-view-subheader {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
      font-weight: 400;
    }

    .detail-content {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 20px;
    }

    .detail-text {
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.6;
      color: var(--text-secondary);
      white-space: pre-wrap;
    }

    .detail-files {
      border-top: 1px solid var(--border);
      padding-top: 12px;
    }

    .detail-files-header {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .detail-files-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .detail-files-grid .file-item {
      flex: 0 0 auto;
      min-width: 0;
    }

    /* Bottom Bar */
    .bottom-bar {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: rgba(0,0,0,0.22);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-shrink: 0;
    }

    .bottom-bar-left {
      display: flex;
      align-items: center;
      gap: 12px;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-muted);
    }

    .shortcuts-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-muted);
    }

    .shortcuts-bar .shortcut {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .shortcuts-bar .shortcut .kbd {
      margin-right: 2px;
    }


    

    .bottom-bar-right {
      display: flex;
      gap: 10px;
    }

    /* Dropdown / Popover */
    .dropdown-container { position: relative; }

    .dropdown {
      display: none;
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      min-width: 280px;
      background: rgba(9,9,11,0.96);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      z-index: 100;
      overflow: hidden;
    }
    .dropdown.show { display: block; }

    .dropdown-header {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      background: rgba(0,0,0,0.25);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .dropdown-header .branch-count {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 400;
    }

    .dropdown-search {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      position: relative;
    }

    .dropdown-search input {
      width: 100%;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 32px 8px 12px;
      font-size: 12px;
      color: var(--text-primary);
    }
    .dropdown-search input:focus { outline: none; border-color: var(--border-light); }
    .dropdown-search input::placeholder { color: var(--text-muted); }

    .clear-btn {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      display: none;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.15s;
    }
    .clear-btn:hover { 
      background: var(--accent-dim); 
      color: var(--text-secondary);
    }
    .clear-btn.show { display: flex; }

    .clear-btn svg {
      width: 14px;
      height: 14px;
    }

    .dropdown-list {
      max-height: 240px;
      overflow-y: auto;
      padding: 6px;
    }

    .dropdown-item {
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.12s;
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: space-between;
    }
    .dropdown-item:hover { background: var(--accent-dim); color: var(--text-primary); }

    .dropdown-item.selected { background: var(--accent-dim); color: var(--text-primary); }

    .dropdown-item .branch-icon {
      width: 14px;
      height: 14px;
      opacity: 0.6;
    }

    .branch-current-indicator {
      font-size: 11px;
      color: var(--text-muted);
      font-family: var(--mono);
      margin-left: auto;
      padding-left: 8px;
    }

    /* Reviewer Dropdown */
    .reviewer-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.12s;
    }
    .reviewer-row:hover { background: var(--accent-dim); }

    .reviewer-checkbox {
      width: 16px;
      height: 16px;
      appearance: none;
      border: 1.5px solid var(--border-light);
      border-radius: 4px;
      background: var(--bg-primary);
      cursor: pointer;
      position: relative;
      flex-shrink: 0;
    }
    .reviewer-checkbox:checked {
      background: var(--text-primary);
      border-color: var(--text-primary);
    }
    .reviewer-checkbox:checked::after {
      content: '✓';
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--bg-primary);
      font-size: 10px;
      font-weight: bold;
    }

    .reviewer-info { flex: 1; min-width: 0; }
    .reviewer-info .name {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
    }
    .reviewer-info .handle {
      font-size: 11px;
      color: var(--text-muted);
      font-family: var(--mono);
    }

    /* Overlay */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.70);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }
    .overlay.show { display: flex; }

    .overlay-content {
      background: rgba(9,9,11,0.95);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      width: min(520px, calc(100vw - 36px));
      overflow: hidden;
    }

    .overlay-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: rgba(0,0,0,0.25);
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .overlay-header-counter {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 400;
    }

    .overlay-body {
      padding: 12px 16px;
    }

    /* Progress Steps */
    .progress-steps {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .step {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 8px 0px;
      border-radius: 12px;
      background: transparent;
      border: none;
      font-family: var(--mono);
      font-size: 12.5px;
      color: var(--text-primary);
      transition: all 0.2s;
    }

    .step.done {
      color: var(--text-secondary);
      background: transparent;
    }

    .step-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }

    .step-indicator {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      flex-shrink: 0;
      position: relative;
      font-family: system-ui, -apple-system, sans-serif;
      font-weight: 400;
    }

    .step.active .step-indicator {
      border-color: rgba(251, 146, 60, 0.3);
    }
    
    .step.done .step-indicator {
      border-color: var(--green);
      background: rgba(34,197,94,0.15);
      color: var(--green);
    }

    .step-spinner {
      position: absolute;
      inset: -2px;
      border-radius: 50%;
      border: 2px solid rgba(251, 146, 60, 0.25);
      border-top-color: rgba(251, 146, 60, 0.9);
      animation: spin 0.8s linear infinite;
    }

    .step-text {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .step-status {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text-muted);
      flex-shrink: 0;
      min-width: 180px;
      text-align: right;
    }

    .step.active .step-status {
      color: var(--orange);
    }

    .step.done .step-status {
      color: var(--green);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.96); }
      to { opacity: 1; transform: scale(1); }
    }
    .overlay.show .overlay-content {
      animation: fadeIn 0.22s ease;
    }

    /* Split Button Container */
    .split-btn-container {
      display: inline-flex;
      position: relative;
      vertical-align: middle;
    }

    /* Apply unified hover effect to entire container */
    .split-btn-container:hover .btn {
      background: #e4e4e7 !important;
      border-color: var(--border-light) !important;
    }

    /* Apply unified active effect to entire container */
    .split-btn-container:active .btn {
      transform: translateY(1px) !important;
    }

    /* Remove default margins */
    .split-btn-container .btn {
      margin: 0;
    }

    /* Main Button (Left) */
    #btnCreate {
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
      border-right: none;
      padding-right: 12px;
      position: relative;
    }

    /* Vertical Separator */
    #btnCreate::after {
      content: '';
      position: absolute;
      right: 0;
      top: 20%;
      height: 60%;
      width: 1px;
      background: rgba(113, 113, 122, 0.4);
      z-index: 1;
    }

    /* Chevron Button (Right) */
    #btnCreateMenuToggle {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
      border-left: none;
      padding-left: 8px;
      padding-right: 8px;
      width: 32px;
    }

    /* Disabled State */
    .split-btn-container.disabled {
      opacity: 0.5;
    }

    .split-btn-container.disabled:hover .btn {
      background: rgba(0,0,0,0.22);
    }

    /* Popover Menu */
    .popover-menu {
      position: absolute;
      bottom: 100%;
      right: 0;
      margin-bottom: 8px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      width: 380px;              /* Fixed width as requested */
      height: 140px;             /* Fixed height as requested */
      min-width: 250px;
      display: none;
      z-index: 1000; /* Higher z-index to appear above everything */
      overflow: hidden;
      flex-direction: column;
      /* REMOVE: white-space: nowrap; */
    }

    .popover-menu.show {
      display: flex;
    }

    /* Popover that opens downward (used for top bar Generate split button) */
    .popover-menu.popover-down {
      bottom: auto;
      top: 100%;
      margin-top: 8px;
      margin-bottom: 0;
    }

    /* Generate split button: match Create split button styling */
    #btnGenerate {
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
      border-right: none;
      padding-right: 12px;
      position: relative;
    }

    /* Vertical Separator */
    #btnGenerate::after {
      content: '';
      position: absolute;
      right: 0;
      top: 20%;
      height: 60%;
      width: 1px;
      background: rgba(113, 113, 122, 0.4);
      z-index: 1;
    }

    /* Chevron Button (Right) */
    #btnGenerateMenuToggle {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
      border-left: none;
      padding-left: 8px;
      padding-right: 8px;
      width: 32px;
    }

    .menu-item {
      padding: 12px 16px;
      font-size: 14px;
      cursor: pointer;
      color: var(--text-primary);
      transition: background 0.2s;
      display: flex;
      align-items: flex-start;      /* Changed from center to flex-start */
      justify-content: space-between; /* Push shortcut to right */
      gap: 12px;                    /* Add gap between title/desc and shortcut */
      /* REMOVE: white-space: nowrap; */
    }

    .menu-item:hover {
      background: var(--bg-hover);
    }

    .menu-item span.desc {
      display: block; /* Subtitle below title */
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px; /* Space below title */
      white-space: normal;          /* Changed from nowrap to normal */
      line-height: 1.4;             /* Add line-height for readability */
    }

    .menu-shortcut {
      font-size: 11px;
      color: var(--text-muted);
      font-family: var(--mono);
      margin-left: 12px;
      white-space: nowrap;          /* Keep shortcuts on single line */
      flex-shrink: 0;
      align-self: flex-start;       /* Align to top when desc wraps */
      margin-top: 2px;              /* Small offset to align with title */
    }

    .menu-shortcut .kbd {
      padding: 2px 6px;
      background: var(--kbd-bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 10px;
      font-family: var(--mono);
      display: inline-block;
      vertical-align: baseline;
      margin-right: 3px;
    }

    .menu-shortcut .kbd:last-child {
      margin-right: 0;
    }

    .prompt-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
      line-height: 1.5;
    }

    .prompt-input {
      width: 100%;
      background: rgba(0,0,0,0.25);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 14px;
      font-family: var(--sans);
      font-size: 13px;
      color: var(--text-primary);
      resize: vertical;
      min-height: 120px;
      margin-bottom: 16px;
    }

    .prompt-input:focus {
      outline: none;
      border-color: var(--border-light);
    }

    .model-selector {
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .model-selector .form-label {
      margin-bottom: 0;
      min-width: 50px;
    }

    .model-selector .form-input {
      flex: 1;
      margin-bottom: 0;
    }

    /* Style the select dropdown chevron */
    .model-selector .form-input {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23a1a1aa' stroke-width='2'%3e%3cpolyline points='6 9 12 15 18 9'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 12px;
      padding-right: 30px;
      background-color: rgba(0,0,0,0.25);
    }

    .prompt-actions {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: rgba(0,0,0,0.22);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* Context Menu */
    .context-menu {
      position: fixed;
      background: rgba(9,9,11,0.96);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      min-width: 180px;
      z-index: 1000;
      display: none;
      overflow: hidden;
    }

    .context-menu.show {
      display: block;
    }

    .context-menu-item {
      padding: 10px 14px;
      font-size: 13px;
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.15s;
    }

    .context-menu-item:hover {
      background: var(--bg-hover);
    }

    .context-menu-item svg {
      width: 14px;
      height: 14px;
      opacity: 0.7;
    }

    .context-menu-separator {
      height: 1px;
      background: var(--border);
      margin: 4px 0;
    }
  </style>
<script type="module" crossorigin src="./pr-kq0291m9.js"></script></head>
<body>

  <!-- Main Window -->
  <div class="window">

    <!-- Status Bar -->
    <div class="status-bar">
      <div class="traffic-lights">
        <div class="traffic-light red"></div>
        <div class="traffic-light yellow"></div>
        <div class="traffic-light green"></div>
      </div>
      <div class="status-title">Omni — Pull Request</div>
      <div class="status-spacer"></div>
    </div>

    <!-- Main Content -->
    <div class="main-content">

      <!-- Left Sidebar -->
      <aside class="sidebar">

        <!-- Pull Request Overview -->
        <div class="sidebar-section">
          <div class="section-header">
            <span class="label">Pull request overview</span>
          </div>
          <div id="prOverview">
            <div class="pr-item active" data-pr-id="pr">
              <span class="pr-number">my-project/pr/#549</span>
              <span class="pr-status mergeable">Ready to merge</span>
            </div>
          </div>
        </div>

        <!-- Commits Overview -->
        <div class="sidebar-section">
          <div class="section-header">
            <span class="label">Commits overview</span>
            <span class="meta" id="commitCount">3 Commits</span>
          </div>
          <div id="commitList">
            <div class="commit-item" data-commit-id="0">
              <span class="commit-dot"></span>
              <span class="commit-msg">feat(ui): add branch picker</span>
            </div>
            <div class="commit-item" data-commit-id="1">
              <span class="commit-dot"></span>
              <span class="commit-msg">feat(ai): generate title/description</span>
            </div>
            <div class="commit-item" data-commit-id="2">
              <span class="commit-dot"></span>
              <span class="commit-msg">chore: polish copy & spacing</span>
            </div>
          </div>
        </div>

        <!-- File Overview -->
        <div class="sidebar-section">
          <div class="section-header">
            <span class="label">File overview</span>
            <span class="meta" id="fileCount">4 Files</span>
          </div>
          <div id="fileList">
            <div class="file-item" data-file-id="0">
              <span class="file-status M">M</span>
              <span class="file-path">src/ui/BranchPicker.tsx</span>
              <span class="file-changes"><span class="add">+50</span> <span class="rem">-10</span></span>
            </div>
            <div class="file-item" data-file-id="1">
              <span class="file-status A">A</span>
              <span class="file-path">src/ui/ReviewerPopover.tsx</span>
              <span class="file-changes"><span class="add">+68</span> <span class="rem">-0</span></span>
            </div>
            <div class="file-item" data-file-id="2">
              <span class="file-status M">M</span>
              <span class="file-path">src/ai/generatePr.ts</span>
              <span class="file-changes"><span class="add">+31</span> <span class="rem">-2</span></span>
            </div>
            <div class="file-item" data-file-id="3">
              <span class="file-status R">R</span>
              <span class="file-path">README.md</span>
              <span class="file-changes"><span class="add">+7</span> <span class="rem">-1</span></span>
            </div>
          </div>
        </div>
      </aside>

      <!-- Details Panel -->
      <section class="details-panel">
        
        <!-- Top Bar - Moved inside Details Panel -->
        <div class="top-bar" id="topBar">
          <div class="dropdown-container">
            <button class="btn" id="btnSource">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="6" y1="3" x2="6" y2="15"></line>
                <circle cx="18" cy="6" r="3"></circle>
                <circle cx="6" cy="18" r="3"></circle>
                <path d="M18 9a9 9 0 0 1-9 9"></path>
              </svg>
              <span id="sourceBranchText">Source: develop</span>
              <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
            <div class="dropdown" id="sourceDropdown">
              <div class="dropdown-header">
                <span>Select source branch</span>
                <span class="branch-count" id="sourceBranchCount">0</span>
              </div>
              <div class="dropdown-search">
                <input type="text" placeholder="Filter branches..." id="sourceFilter">
                <button class="clear-btn" id="sourceClearBtn">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
              <div class="dropdown-list" id="sourceList"></div>
            </div>
          </div>

          <div class="dropdown-container">
            <button class="btn" id="btnDest">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="18" cy="18" r="3"></circle>
                <circle cx="6" cy="6" r="3"></circle>
                <path d="M6 21V9a9 9 0 0 0 9 9"></path>
              </svg>
              <span id="destBranchText">Target: main</span>
              <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
            <div class="dropdown" id="destDropdown">
              <div class="dropdown-header">
                <span>Select target branch</span>
                <span class="branch-count" id="destBranchCount">0</span>
              </div>
              <div class="dropdown-search">
                <input type="text" placeholder="Filter branches..." id="destFilter">
                <button class="clear-btn" id="destClearBtn">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
              <div class="dropdown-list" id="destList"></div>
            </div>
          </div>

          <div class="dropdown-container">
            <button class="btn" id="btnReviewers">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              <span>Pick reviewers</span>
              <span id="reviewerBadge" style="background:var(--border);padding:2px 8px;border-radius:999px;font-size:11px;margin-left:4px;display:none;">0</span>
              <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
            <div class="dropdown" id="reviewerDropdown" style="min-width:300px;">
              <div class="dropdown-header">Select reviewers</div>
              <div class="dropdown-list" id="reviewerList" style="padding:8px;"></div>
            </div>
          </div>

          <div class="split-btn-container" id="generateSplitContainer">
            <!-- Main Action -->
            <button class="btn btn-primary" id="btnGenerate">
              <span id="generateButtonText">Generate pull request</span>
            </button>

            <!-- Chevron / Menu Toggle -->
            <button class="btn btn-primary" id="btnGenerateMenuToggle" aria-label="Generate pull request options">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>

            <!-- Popover Menu (opens downward from top bar) -->
            <div class="popover-menu popover-down" id="generateMenuPopover">
              <div class="menu-item" id="optGenerateDefault">
                <div>
                  Generate pull request
                  <span class="desc">Generate pull requests based on the current file changes</span>
                </div>
                <span class="menu-shortcut">
                  <span class="kbd">⌘</span><span class="kbd">G</span>
                </span>
              </div>

              <div class="menu-item" id="optGenerateWithOptions">
                <div>
                  Generate pull request w/ options
                  <span class="desc">Generate pull requests based on the current commits and user prompt</span>
                </div>
                <span class="menu-shortcut">
                  <span class="kbd">⇧</span><span class="kbd">⌘</span><span class="kbd">G</span>
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Content Area -->
        <div class="details-content-area">
        
          <!-- PR Details View (Default) -->
          <div class="detail-view active" id="prDetailsView">
            <div class="form-group">
              <label class="form-label">Title</label>
              <input type="text" class="form-input" id="prTitle" placeholder="(Generate to fill) e.g., Improve PR creation UX">
            </div>

            <div class="form-group flex-grow">
              <label class="form-label">Description</label>
              <textarea class="form-input" id="prDescription" placeholder="(Generate to fill) e.g., Summary, testing notes, screenshots..."></textarea>
            </div>
          </div>

          <!-- Commit Detail View -->
          <div class="detail-view" id="commitDetailView">
            <div class="detail-view-header">
              <!-- Modified Header Row -->
              <div class="detail-header-row">
                <div id="commitDetailTitle">feat(ui): add branch picker</div>
                <div class="detail-header-buttons">
                  <button class="detail-header-btn" id="showOnGitHub">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                      <polyline points="15 3 21 3 21 9"></polyline>
                      <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                    Show on GitHub
                  </button>
                  <button class="detail-header-btn" id="copySHA">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                    Copy SHA to clipboard
                  </button>
                </div>
              </div>
              <!-- New Subtitle Row -->
              <div class="detail-header-subtitle" id="commitDetailSubtitle">SHA: abc123f • 20240105123045 • john.doe</div>
            </div>

            <div class="detail-content">
              <div class="detail-text" id="commitDetailDescription">...</div>
            </div>

            <div class="detail-files">
              <!-- Modified Files Header -->
              <div class="detail-files-header">
                <span>Files in commit</span>
                <span class="detail-files-stats" id="commitFileStats">
                  <!-- Stats will be injected here via JS -->
                </span>
              </div>
              <div class="detail-files-grid" id="commitDetailFiles">
                <!-- File items will be populated here -->
              </div>
            </div>
          </div>

          <!-- File Detail View -->
          <div class="detail-view" id="fileDetailView">
            <div class="detail-view-header">
              <!-- Header Row with Title and Buttons -->
              <div class="detail-header-row">
                <div id="fileDetailName">src/ui/BranchPicker.tsx</div>
                <div class="detail-header-buttons">
                  <button class="detail-header-btn" id="showInFileBrowser">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                    Show in file-browser
                  </button>
                  <button class="detail-header-btn" id="openInIDE">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="16 18 22 12 16 6"></polyline>
                      <polyline points="8 6 2 12 8 18"></polyline>
                    </svg>
                    Open in IDE
                  </button>
                  <button class="detail-header-btn" id="showFileOnGitHub">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                      <polyline points="15 3 21 3 21 9"></polyline>
                      <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                    Show on GitHub
                  </button>
                </div>
              </div>

              <!-- Subtitle Group -->
              <div class="detail-header-subtitle-group" id="fileDetailSubtitles">
                <div class="detail-header-subtitle-row">dist/app-bundle.zip • 2026-12-24 16:45:12 • 2.0mb</div>
                <div class="detail-header-subtitle-row">SHA: 19dce5f0d2d04f31c4c27f72cb57fdbb1dc63637</div>
              </div>
            </div>

            <div class="detail-content">
              <div class="detail-text" id="fileDetailContent"></div>
            </div>
          </div>

        </div>
      </section>
    </div>

    <!-- Bottom Bar -->
    <div class="bottom-bar">
      <div class="bottom-bar-left">
        <div class="shortcuts-bar">
          <span>Keyboard</span>
          <span class="shortcut">
            <span class="kbd">␛</span> Cancel
          </span>
          <span class="shortcut">
            <span class="kbd">⏎</span> Create PR
          </span>
          <span class="shortcut">
            <span class="kbd">⇧</span>
            <span class="kbd">⏎</span>
            Create PR + Merge
          </span>
        </div>
      </div>
      <div class="bottom-bar-right">
        <button class="btn btn-ghost" id="btnCancel">Cancel</button>
        <div class="split-btn-container">
          <!-- Main Action -->
          <button class="btn btn-primary" id="btnCreate" disabled>
            Create Pull Request
          </button>

          <!-- Chevron / Menu Toggle -->
          <button class="btn btn-primary" id="btnCreateMenuToggle" disabled>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>

          <!-- Popover Menu -->
          <div class="popover-menu" id="createMenuPopover">
            <div class="menu-item" id="optCreate">
              <div>
                Create pull-request
                <span class="desc">Create the PR and leave it open</span>
              </div>
              <span class="menu-shortcut"><span class="kbd">↵</span></span>
            </div>
            <div class="menu-item" id="optCreateMerge">
              <div>
                Create pull-request and merge
                <span class="desc">Create and immediately merge</span>
              </div>
              <span class="menu-shortcut"><span class="kbd">⇧</span><span class="kbd">↵</span></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Generate Progress Overlay -->
  <div class="overlay" id="generateOverlay">
    <div class="overlay-content">
      <div class="overlay-header">
        <span>Generating Pull Request</span>
        <span class="overlay-header-counter" id="genCounter">0/4</span>
      </div>
      <div class="overlay-body">
        <div class="progress-steps" id="generateSteps">
          <div class="step" data-step="0">
            <div class="step-left">
              <div class="step-indicator"></div>
              <span class="step-text">Analyzing branch diff</span>
            </div>
            <span class="step-status">queue</span>
          </div>
          <div class="step" data-step="1">
            <div class="step-left">
              <div class="step-indicator"></div>
              <span class="step-text">Summarizing commit descriptions</span>
            </div>
            <span class="step-status">queue</span>
          </div>
          <div class="step" data-step="2">
            <div class="step-left">
              <div class="step-indicator"></div>
              <span class="step-text">Generating PR body</span>
            </div>
            <span class="step-status">queue</span>
          </div>
          <div class="step" data-step="3">
            <div class="step-left">
              <div class="step-indicator"></div>
              <span class="step-text">Finalizing PR proposal</span>
            </div>
            <span class="step-status">queue</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create PR Progress Overlay -->
  <div class="overlay" id="createOverlay">
    <div class="overlay-content">
      <div class="overlay-header">
        <span>Creating Pull Request</span>
        <span class="overlay-header-counter" id="createCounter">0/4</span>
      </div>
      <div class="overlay-body">
        <div class="progress-steps" id="createSteps">
          <div class="step" data-step="0">
            <div class="step-left">
              <div class="step-indicator"></div>
              <span class="step-text">Preparing pull request</span>
            </div>
            <span class="step-status">queue</span>
          </div>
          <div class="step" data-step="1">
            <div class="step-left">
              <div class="step-indicator"></div>
              <span class="step-text">Pushing to GitHub</span>
            </div>
            <span class="step-status">queue</span>
          </div>
          <div class="step" data-step="2">
            <div class="step-left">
              <div class="step-indicator"></div>
              <span class="step-text">Configuring PR metadata</span>
            </div>
            <span class="step-status">queue</span>
          </div>
          <div class="step" data-step="3">
            <div class="step-left">
              <div class="step-indicator"></div>
              <span class="step-text">Pull request created!</span>
            </div>
            <span class="step-status">queue</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Prompt Popup Overlay -->
  <div class="overlay" id="promptOverlay">
    <div class="overlay-content">
      <div class="overlay-header">
        <span>Generate pull requests with options</span>
      </div>
      <div class="overlay-body">
      <div class="prompt-subtitle">Provide additional context to generate more accurate pull request messages</div>
      <textarea class="prompt-input" id="promptInput" placeholder="Example: Focus on key changes, breaking changes (if any), and testing steps." rows="6"></textarea>
        <div class="model-selector">
          <label class="form-label">Model</label>
          <select class="form-input" id="modelSelect">
            <option value="gpt-4" selected>GPT-4 (Default)</option>
            <option value="gpt-4-turbo">GPT-4 Turbo</option>
            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
            <option value="claude-3-opus">Claude 3 Opus</option>
            <option value="claude-3-sonnet">Claude 3 Sonnet</option>
          </select>
        </div>
      </div>
      <div class="prompt-actions">
        <button class="btn btn-ghost" id="btnPromptCancel">Cancel</button>
        <button class="btn btn-primary" id="btnPromptGenerate">Generate</button>
      </div>
    </div>
  </div>

<!-- Context Menu for Commits -->
<div class="context-menu" id="commitContextMenu">
  <div class="context-menu-item" id="ctxCopySha">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
    </svg>
    Copy SHA
  </div>
  <div class="context-menu-item" id="ctxViewOnGitHub">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
      <polyline points="15 3 21 3 21 9"></polyline>
      <line x1="10" y1="14" x2="21" y2="3"></line>
    </svg>
    View on GitHub
  </div>
</div>

<!-- Context Menu for Files -->
<div class="context-menu" id="fileContextMenu">
  <div class="context-menu-item" id="ctxRevealInFileBrowser">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
    </svg>
    Reveal in file-browser
  </div>
  <div class="context-menu-item" id="ctxFileViewOnGitHub">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
      <polyline points="15 3 21 3 21 9"></polyline>
      <line x1="10" y1="14" x2="21" y2="3"></line>
    </svg>
    View on GitHub
  </div>
  <div class="context-menu-item" id="ctxOpenWithDefault">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"></circle>
      <polygon points="10 8 16 12 10 16 10 8"></polygon>
    </svg>
    Open with default program
  </div>
  <div class="context-menu-separator"></div>
  <div class="context-menu-item" id="ctxCopyFilePath">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
    </svg>
    Copy file path
  </div>
</div>

  <script>
    // Data
    const branches = [
      'main',
      'develop',
      'release/1.8.0',
      'feature/pr-window-ui',
      'release/hot-fix',
      'hotfix/critical-null-check',
      'chore/refactor-api-client'
    ];

    const reviewers = [
      { 
        id: 'sarah', 
        name: 'Sarah Chen', 
        handle: '@sara99', 
        email: 'sarah.chen@company.com'
      },
      { 
        id: 'noah', 
        name: 'Noah Eriksen', 
        handle: '@noah_e', 
        email: 'noah.eriksen@company.com'
      },
      { 
        id: 'mia', 
        name: 'Mia Solheim', 
        handle: '@miaS', 
        email: 'mia.solheim@company.com'
      },
      { 
        id: 'liam', 
        name: 'Liam Jensen', 
        handle: '@liamj', 
        email: 'liam.jensen@company.com'
      },
      { 
        id: 'zoe', 
        name: 'Zoë Larsen', 
        handle: '@zoe_l', 
        email: 'zoe.larsen@company.com'
      }
    ];

    const commits = [
      {
        id: 0,
        title: 'feat(ui): add branch picker',
        sha: "abc123f456e789d012345678901234567890abcd", // Add this
        date: "20240105123045", // Add this
        author: "john.doe", // Add this
        description: `Added interactive branch picker component with dropdown functionality.

Features:
- Search/filter branches
- Real-time branch selection
- Visual feedback for selected branches
- Keyboard navigation support`,
        files: [
          { path: 'src/ui/BranchPicker.tsx', status: 'A', add: 120, rem: 0 },
          { path: 'src/ui/index.ts', status: 'M', add: 1, rem: 0 }
        ]
      },
      {
        id: 1,
        title: 'feat(ai): generate title/description',
        sha: "def456g789h012i345678901234567890123bcde", // Add this
        date: "20240105123115", // Add this
        author: "jane.smith", // Add this
        description: `Implemented AI-powered PR title and description generation.

Uses GPT-4 to analyze:
- Commit messages
- File changes
- Code diffs

Generates contextual PR descriptions automatically.`,
        files: [
          { path: 'src/ai/generatePr.ts', status: 'A', add: 85, rem: 0 },
          { path: 'src/api/openai.ts', status: 'M', add: 12, rem: 3 }
        ]
      },
      {
        id: 2,
        title: 'chore: polish copy & spacing',
        sha: "ghi789j012k345l6789012345678901234567fgh", // Add this
        date: "20240105123200", // Add this
        author: "bob.wilson", // Add this
        description: `Minor UI polish updates:
- Adjusted spacing in sidebar sections
- Updated placeholder text
- Fixed typos in labels`,
        files: [
          { path: 'src/ui/Sidebar.tsx', status: 'M', add: 8, rem: 5 },
          { path: 'README.md', status: 'M', add: 7, rem: 1 }
        ]
      }
    ];

    const files = [
      {
        id: 0,
        path: 'src/ui/BranchPicker.tsx',
        status: 'M',
        add: 50,
        rem: 10,
        // Add these fields:
        size: '12kb',
        date: '2026-12-24 16:45:12',
        sha: '19dce5f0d2d04f31c4c27f72cb57fdbb1dc63637',
        content: `import React, { useState } from 'react';
import { ChevronDown } from 'lucide-react';

interface BranchPickerProps {
  branches: string[];
  selected?: string;
  onChange: (branch: string) => void;
}

export const BranchPicker: React.FC<BranchPickerProps> = ({
  branches,
  selected,
  onChange
}) => {
  const [isOpen, setIsOpen] = useState(false);
  const [filter, setFilter] = useState('');

  const filtered = branches.filter(b =>
    b.toLowerCase().includes(filter.toLowerCase())
  );

  return (
    <div className="branch-picker">
      <button onClick={() => setIsOpen(!isOpen)}>
        {selected || 'Select branch'}
        <ChevronDown />
      </button>
      {isOpen && (
        <div className="dropdown">
          <input
            type="text"
            value={filter}
            onChange={e => setFilter(e.target.value)}
            placeholder="Filter branches..."
          />
          {filtered.map(branch => (
            <div
              key={branch}
              onClick={() => {
                onChange(branch);
                setIsOpen(false);
              }}
            >
              {branch}
            </div>
          ))}
        </div>
      )}
    </div>
  );
};`
      },
      {
        id: 1,
        path: 'src/ui/ReviewerPopover.tsx',
        status: 'A',
        add: 68,
        rem: 0,
        // Add these fields:
        size: '15kb',
        date: '2026-12-24 16:42:33',
        sha: 'a8f9e1c2b3d04e5f6g7h8i9j0k1l2m3n4o5p6q',
        content: `import React from 'react';

interface Reviewer {
  id: string;
  name: string;
  email: string;
}

interface ReviewerPopoverProps {
  reviewers: Reviewer[];
  selected: Set<string>;
  onChange: (selected: Set<string>) => void;
}

export const ReviewerPopover: React.FC<ReviewerPopoverProps> = ({
  reviewers,
  selected,
  onChange
}) => {
  const toggleReviewer = (id: string) => {
    const newSelected = new Set(selected);
    if (newSelected.has(id)) {
      newSelected.delete(id);
    } else {
      newSelected.add(id);
    }
    onChange(newSelected);
  };

  return (
    <div className="reviewer-popover">
      {reviewers.map(reviewer => (
        <label key={reviewer.id}>
          <input
            type="checkbox"
            checked={selected.has(reviewer.id)}
            onChange={() => toggleReviewer(reviewer.id)}
          />
          <span>{reviewer.name}</span>
          <span>{reviewer.email}</span>
        </label>
      ))}
    </div>
  );
};`
      },
      {
        id: 2,
        path: 'src/ai/generatePr.ts',
        status: 'M',
        add: 31,
        rem: 2,
        // Add these fields:
        size: '8kb',
        date: '2026-12-24 16:38:45',
        sha: 'b7c8d9e0f1a2b3c4d5e6f7g8h9i0j1k2l3m4n5',
        content: `import OpenAI from 'openai';

interface GeneratePROptions {
  commits: string[];
  files: string[];
  sourceBranch: string;
  targetBranch: string;
}

export async function generatePR(options: GeneratePROptions) {
  const openai = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY
  });

  const prompt = buildPrompt(options);

  const response = await openai.chat.completions.create({
    model: 'gpt-4',
    messages: [
      { role: 'system', content: 'You are a helpful assistant that generates PR descriptions.' },
      { role: 'user', content: prompt }
    ]
  });

  return response.choices[0].message.content;
}

function buildPrompt(options: GeneratePROptions): string {
  return \`Generate a PR title and description for:
- Source: \${options.sourceBranch}
- Target: \${options.targetBranch}
- Commits: \${options.commits.join(', ')}
- Files: \${options.files.join(', ')}\`;
}`
      },
      {
        id: 3,
        path: 'README.md',
        status: 'R',
        add: 7,
        rem: 1,
        // Add these fields:
        size: '3kb',
        date: '2026-12-24 16:35:22',
        sha: 'c6d7e8f9a0b1c2d3e4f5g6h7i8j9k0l1m2n3o4',
        content: `# Omni PR Tool

An intelligent pull request creation tool with AI-powered descriptions.

## Features

- 🔀 Branch picker with search
- 👥 Reviewer selection
- 🤖 AI-generated PR descriptions
- 📊 Commit and file overview
- ✨ Beautiful dark UI

## Usage

1. Select source and target branches
2. Pick reviewers
3. Click "Generate pull request"
4. Review and create

## Tech Stack

- React
- TypeScript
- OpenAI GPT-4
- Tailwind CSS`
      }
    ];

    // Sub-steps for each main step
    const genSubSteps = [
      ['Reading branch metadata...', 'Computing file differences...', 'Parsing commit history...', 'Analyzing code changes...'],
      ['Loading commit messages...', 'Extracting key changes...', 'Identifying patterns...', 'Generating summary...'],
      ['Formatting description...', 'Adding testing notes...', 'Including code snippets...', 'Finalizing markdown...'],
      ['Validating PR metadata...', 'Checking branch permissions...', 'Preparing final payload...', 'Ready to create...']
    ];

    const createSubSteps = [
      ['Collecting PR metadata...', 'Validating inputs...', 'Building request body...', 'Verifying permissions...', 'Payload ready...'],
      ['Connecting to GitHub API...', 'Authenticating request...', 'Enumerating objects...', 'Compressing objects...', 'Writing objects: 100%...', 'Submitting PR data...', 'PR created on GitHub...'],
      ['Fetching reviewer IDs...', 'Assigning reviewers...', 'Reviewers notified...', 'Updating PR metadata...', 'Running final checks...', 'Syncing status...'],
      ['PR created successfully!', 'All checks passed', 'Ready for review', 'Done']
    ];

    // State
    let sourceBranch = 'develop';
    let destBranch = 'main';
    const selectedReviewers = new Set();
    let currentView = 'pr';
    let currentCommitId = 0; // Track current commit for button handlers

    // Elements
    const topBar = document.getElementById('topBar');
    const btnSource = document.getElementById('btnSource');
    const btnDest = document.getElementById('btnDest');
    const btnReviewers = document.getElementById('btnReviewers');
    const btnGenerate = document.getElementById('btnGenerate');
    const btnCreate = document.getElementById('btnCreate');
    const btnCancel = document.getElementById('btnCancel');
    const generateButtonText = document.getElementById('generateButtonText');
    const sourceDropdown = document.getElementById('sourceDropdown');
    const destDropdown = document.getElementById('destDropdown');
    const reviewerDropdown = document.getElementById('reviewerDropdown');
    const sourceList = document.getElementById('sourceList');
    const destList = document.getElementById('destList');
    const reviewerList = document.getElementById('reviewerList');
    const sourceFilter = document.getElementById('sourceFilter');
    const destFilter = document.getElementById('destFilter');
    const sourceClearBtn = document.getElementById('sourceClearBtn');
    const destClearBtn = document.getElementById('destClearBtn');
    const sourceBranchCount = document.getElementById('sourceBranchCount');
    const destBranchCount = document.getElementById('destBranchCount');
    const prTitle = document.getElementById('prTitle');
    const prDescription = document.getElementById('prDescription');
    const generateOverlay = document.getElementById('generateOverlay');
    const createOverlay = document.getElementById('createOverlay');
    const reviewerBadge = document.getElementById('reviewerBadge');
    const genCounter = document.getElementById('genCounter');
    const createCounter = document.getElementById('createCounter');

    // Generate split button elements
    const generateSplitContainer = document.getElementById('generateSplitContainer');
    const btnGenerateMenuToggle = document.getElementById('btnGenerateMenuToggle');
    const generateMenuPopover = document.getElementById('generateMenuPopover');
    const optGenerateDefault = document.getElementById('optGenerateDefault');
    const optGenerateWithOptions = document.getElementById('optGenerateWithOptions');

    // Prompt popup elements
    const promptOverlay = document.getElementById('promptOverlay');
    const promptInput = document.getElementById('promptInput');
    const modelSelect = document.getElementById('modelSelect');
    const btnPromptCancel = document.getElementById('btnPromptCancel');
    const btnPromptGenerate = document.getElementById('btnPromptGenerate');

    // Detail view elements
    const prDetailsView = document.getElementById('prDetailsView');
    const commitDetailView = document.getElementById('commitDetailView');
    const fileDetailView = document.getElementById('fileDetailView');

    // Helpers
    function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    function closeAllDropdowns() {
      sourceDropdown.classList.remove('show');
      destDropdown.classList.remove('show');
      reviewerDropdown.classList.remove('show');
    }

    function updateGenerateBtn() {
      // Always keep the button enabled visually - no disabled state
      // The button is always clickable, but will show appropriate feedback if branches aren't selected
    }

    function updateCreateBtn() {
      const hasTitle = prTitle.value.trim().length > 0;
      const hasDesc = prDescription.value.trim().length > 0;
      const canCreate = sourceBranch && destBranch && hasTitle && hasDesc;
      // Toggle the container class instead of individual buttons for visual state
      // Use the specific Create button container
      const container = document.querySelector('.bottom-bar .split-btn-container');
      if (canCreate) {
        container.classList.remove('disabled');
        btnCreate.disabled = false;
        btnCreateMenuToggle.disabled = false;
      } else {
        container.classList.add('disabled');
        btnCreate.disabled = true;
        btnCreateMenuToggle.disabled = true;
      }
    }

    function switchView(viewName) {
      currentView = viewName;
      
      prDetailsView.classList.remove('active');
      commitDetailView.classList.remove('active');
      fileDetailView.classList.remove('active');
      
      // Show/hide top bar based on view
      if (viewName === 'pr') {
        prDetailsView.classList.add('active');
        generateButtonText.textContent = 'Generate pull request';
        topBar.classList.remove('hidden');
      } else if (viewName === 'commit') {
        commitDetailView.classList.add('active');
        generateButtonText.textContent = 'Show pull request preview';
        topBar.classList.add('hidden');
      } else if (viewName === 'file') {
        fileDetailView.classList.add('active');
        generateButtonText.textContent = 'Show pull request preview';
        topBar.classList.add('hidden');
      }

      document.querySelectorAll('.pr-item').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.commit-item').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
      
      if (viewName === 'pr') {
        document.querySelector('.pr-item[data-pr-id="pr"]').classList.add('active');
      }
    }

    // Updated showCommitDetail function
    function showCommitDetail(commitId) {
      const commit = commits[commitId];
      currentCommitId = commitId; // Track current commit for button handlers

      // Set title and description
      document.getElementById('commitDetailTitle').textContent = commit.title;
      document.getElementById('commitDetailDescription').textContent = commit.description;

      // NEW: Update subtitle and stats
      updateCommitSubtitle(commit);
      updateFileStats(commit.files);

      // Render files
      const filesHtml = commit.files.map(f => `
        <div class="file-item">
          <span class="file-status ${f.status}">${f.status}</span>
          <span class="file-path">${esc(f.path)}</span>
          <span class="file-changes"><span class="add">+${f.add}</span> <span class="rem">-${f.rem}</span></span>
        </div>
      `).join('');

      const filesContainer = document.getElementById('commitDetailFiles');
      filesContainer.innerHTML = filesHtml;

      switchView('commit');
      document.querySelector(`[data-commit-id="${commitId}"]`).classList.add('active');
    }

    function showFileDetail(fileId) {
      const file = files[fileId];

      // Set Title (just filename, not full path)
      const fileName = file.path.split('/').pop();
      document.getElementById('fileDetailName').textContent = fileName;

      // Update Subtitles
      const subtitleContainer = document.getElementById('fileDetailSubtitles');
      if (subtitleContainer) {
        // Use real values from data or fallbacks
        const dateStr = file.date || '2026-12-24 16:45:12';
        const sizeStr = file.size || '2.0mb';

        subtitleContainer.innerHTML = `
          <div class="detail-header-subtitle-row">${file.path} • ${dateStr} • ${sizeStr}</div>
        `;
      }

      // Render content
      const contentEl = document.getElementById('fileDetailContent');
      // ... (keep existing content rendering logic)
      contentEl.textContent = file.content; // Simple text rendering example

      switchView('file');
      document.querySelector(`[data-file-id="${fileId}"]`).classList.add('active');
    }

    function renderBranchList(container, filter, onSelect, exclude, countElement, clearBtn) {
      const query = filter.value.toLowerCase();
      const filtered = branches.filter(b => 
        b.toLowerCase().includes(query) && b !== exclude
      );
      
      countElement.textContent = `${filtered.length} branches`;
      
      if (filter.value.trim().length > 0) {
        clearBtn.classList.add('show');
      } else {
        clearBtn.classList.remove('show');
      }

      container.innerHTML = filtered.map(b => `
        <div class="dropdown-item" data-branch="${esc(b)}">
          <div style="display: flex; align-items: center; gap: 10px;">
            <svg class="branch-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="6" y1="3" x2="6" y2="15"></line>
              <circle cx="18" cy="6" r="3"></circle>
              <circle cx="6" cy="18" r="3"></circle>
              <path d="M18 9a9 9 0 0 1-9 9"></path>
            </svg>
            ${esc(b)}
          </div>
          ${b === (container.id === 'sourceList' ? sourceBranch : destBranch) ? '<span class="branch-current-indicator">current</span>' : ''}
        </div>
      `).join('');

      container.querySelectorAll('.dropdown-item').forEach(item => {
        item.addEventListener('click', () => {
          onSelect(item.dataset.branch);
          closeAllDropdowns();
        });
      });
    }

    function renderReviewerList() {
      reviewerList.innerHTML = reviewers.map(r => `
        <label class="reviewer-row">
          <input type="checkbox" class="reviewer-checkbox" data-id="${r.id}" ${selectedReviewers.has(r.id) ? 'checked' : ''}>
          <div class="reviewer-info">
            <div class="name">${esc(r.name)}</div>
            <div class="handle">${esc(r.handle)}</div>
          </div>
        </label>
      `).join('');

      reviewerList.querySelectorAll('.reviewer-checkbox').forEach(cb => {
        cb.addEventListener('change', (e) => {
          if (e.target.checked) {
            selectedReviewers.add(e.target.dataset.id);
          } else {
            selectedReviewers.delete(e.target.dataset.id);
          }
          updateReviewerBadge();
        });
      });
    }

    function updateReviewerBadge() {
      const count = selectedReviewers.size;
      reviewerBadge.textContent = count;
      reviewerBadge.style.display = count > 0 ? 'inline' : 'none';
    }

    // New helper to update subtitle
    function updateCommitSubtitle(commit) {
      const subtitle = document.getElementById('commitDetailSubtitle');
      if (!subtitle || !commit) return;

      const shortSha = commit.sha ? commit.sha.substring(0, 7) : 'unknown';
      const formattedDate = formatCommitDate(commit.date || '20240105123045');
      const author = commit.author || 'unknown';

      subtitle.innerHTML = `
        <span class="commit-sha-inline">
          <span>SHA</span>
          <span>${shortSha}</span>
          <button
            type="button"
            class="sha-copy-btn js-copy-commit-sha"
            aria-label="Copy full SHA"
            title="Copy full SHA"
            data-sha="${esc(commit.sha || '')}"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
          </button>
        </span>
        <span> • ${formattedDate} • ${esc(author)}</span>
      `;
    }

    // Helper to format commit date from YYYYMMDDHHMMSS to readable format
    function formatCommitDate(dateStr) {
      // Parse YYYYMMDDHHMMSS format
      const year = dateStr.substring(0, 4);
      const month = parseInt(dateStr.substring(4, 6)) - 1; // JS months are 0-based
      const day = dateStr.substring(6, 8);
      const hour = parseInt(dateStr.substring(8, 10));
      const minute = dateStr.substring(10, 12);

      const date = new Date(year, month, day, hour, minute);

      // Format as "Jan 5, 2024 at 12:30 PM"
      const options = {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      };

      return date.toLocaleDateString('en-US', options).replace(',', '');
    }

    // New helper to update file stats
    function updateFileStats(files) {
      const statsElement = document.getElementById('commitFileStats');
      if (statsElement && files) {
        const fileCount = files.length;
        const totalAdditions = files.reduce((sum, f) => sum + (f.add || 0), 0);
        const totalDeletions = files.reduce((sum, f) => sum + (f.rem || 0), 0);

        statsElement.innerHTML = `
          <span>${fileCount} file${fileCount !== 1 ? 's' : ''}</span>
          <span class="add">${totalAdditions} insertion${totalAdditions !== 1 ? 's' : ''}</span>
          <span class="rem">${totalDeletions} deletion${totalDeletions !== 1 ? 's' : ''}</span>
        `;
      }
    }

    // Event Listeners
    btnSource.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = sourceDropdown.classList.contains('show');
      closeAllDropdowns();
      if (!isOpen) {
        sourceDropdown.classList.add('show');
        renderBranchList(sourceList, sourceFilter, (b) => {
          sourceBranch = b;
          document.getElementById('sourceBranchText').textContent = `Source: ${b}`;
          updateGenerateBtn();
        }, destBranch, sourceBranchCount, sourceClearBtn);
        sourceFilter.focus();
      }
    });

    btnDest.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = destDropdown.classList.contains('show');
      closeAllDropdowns();
      if (!isOpen) {
        destDropdown.classList.add('show');
        renderBranchList(destList, destFilter, (b) => {
          destBranch = b;
          document.getElementById('destBranchText').textContent = `Target: ${b}`;
          updateGenerateBtn();
        }, sourceBranch, destBranchCount, destClearBtn);
        destFilter.focus();
      }
    });

    btnReviewers.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = reviewerDropdown.classList.contains('show');
      closeAllDropdowns();
      if (!isOpen) {
        reviewerDropdown.classList.add('show');
        renderReviewerList();
      }
    });

    sourceFilter.addEventListener('input', () => {
      renderBranchList(sourceList, sourceFilter, (b) => {
        sourceBranch = b;
        document.getElementById('sourceBranchText').textContent = `Source: ${b}`;
        updateGenerateBtn();
      }, destBranch, sourceBranchCount, sourceClearBtn);
    });

    destFilter.addEventListener('input', () => {
      renderBranchList(destList, destFilter, (b) => {
        destBranch = b;
        document.getElementById('destBranchText').textContent = `Target: ${b}`;
        updateGenerateBtn();
      }, sourceBranch, destBranchCount, destClearBtn);
    });

    sourceClearBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      sourceFilter.value = '';
      renderBranchList(sourceList, sourceFilter, (b) => {
        sourceBranch = b;
        document.getElementById('sourceBranchText').textContent = `Source: ${b}`;
        updateGenerateBtn();
      }, destBranch, sourceBranchCount, sourceClearBtn);
      sourceFilter.focus();
    });

    destClearBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      destFilter.value = '';
      renderBranchList(destList, destFilter, (b) => {
        destBranch = b;
        document.getElementById('destBranchText').textContent = `Target: ${b}`;
        updateGenerateBtn();
      }, sourceBranch, destBranchCount, destClearBtn);
      destFilter.focus();
    });

    document.addEventListener('click', closeAllDropdowns);

    [sourceDropdown, destDropdown, reviewerDropdown].forEach(el => {
      el.addEventListener('click', (e) => e.stopPropagation());
    });

    prTitle.addEventListener('input', updateCreateBtn);
    prDescription.addEventListener('input', updateCreateBtn);

    // PR item click handler
    document.querySelector('.pr-item[data-pr-id="pr"]').addEventListener('click', () => {
      switchView('pr');
    });

    document.querySelectorAll('.commit-item').forEach(item => {
      item.addEventListener('click', () => {
        showCommitDetail(parseInt(item.dataset.commitId));
      });
    });

    document.querySelectorAll('.file-item').forEach(item => {
      if (item.dataset.fileId) {
        item.addEventListener('click', () => {
          showFileDetail(parseInt(item.dataset.fileId));
        });
      }
    });

    btnGenerate.addEventListener('click', () => {
      if (currentView === 'pr') {
        runGenerateSteps();
      } else {
        switchView('pr');
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (currentView !== 'pr') {
          switchView('pr');
        } else {
          btnCancel.click();
        }
      } else if (e.key === 'Enter') {
        // Ignore if menu is open and we are navigating (optional, but good practice)

        if (!btnCreate.disabled) {
          if (e.shiftKey) {
            e.preventDefault();
            // Shift + Enter: Create & Merge
            addMergeStep();
            btnCreate.click();
          } else {
            // Normal Enter is usually handled by form submission or existing logic.
            // If you strictly want Enter to ONLY create when not in a text area, check e.target.
            // However, usually Cmd+Enter or Ctrl+Enter is used for form submission.
            // Assuming "Enter" on the button itself or global Enter was the requested behavior.

            // Ensure we don't double-trigger if the user is focused on the button itself
            if (document.activeElement !== btnCreate) {
               // existing enter logic usually handled by form submit or separate listener?
               // The UI shows "Enter Create", so we might need to enforce it:
               // btnCreate.click();
            }
          }
        }
      }

      const isCmdG = e.metaKey && (e.key || '').toLowerCase() === 'g';
      if (isCmdG) {
        if (!btnGenerate.disabled) {
          e.preventDefault();
          if (e.shiftKey) triggerGenerateWithOptions();
          else triggerGenerateDefault();
        }
        return;
      }
    });

    async function runGenerateSteps(mode = 'default', userPrompt = '', selectedModel = 'gpt-4') {
      generateOverlay.classList.add('show');
      const steps = generateOverlay.querySelectorAll('.step');
      const totalSteps = steps.length;

      for (let i = 0; i < steps.length; i++) {
        const step = steps[i];
        const subSteps = genSubSteps[i];
        const statusEl = step.querySelector('.step-status');

        genCounter.textContent = `${i}/${totalSteps}`;

        step.classList.add('active');
        step.querySelector('.step-indicator').innerHTML = '<div class="step-spinner"></div>';

        for (let j = 0; j < subSteps.length; j++) {
          statusEl.textContent = subSteps[j];
          await new Promise(r => setTimeout(r, 100 + Math.random() * 300));
        }

        step.classList.remove('active');
        step.classList.add('done');
        statusEl.textContent = 'done';
        step.querySelector('.step-indicator').innerHTML = '✓';

        genCounter.textContent = `${i + 1}/${totalSteps}`;
      }

      await new Promise(r => setTimeout(r, 100));
      generateOverlay.classList.remove('show');

      steps.forEach(s => {
        s.classList.remove('active', 'done');
        s.querySelector('.step-status').textContent = 'queue';
        s.querySelector('.step-indicator').innerHTML = '';
      });
      genCounter.textContent = '0/4';

      prTitle.value = `Merge ${sourceBranch} into ${destBranch}`;
      prDescription.value =
        `## Summary\n- Adds an interactive PR window layout (status bar, top bar, content, bottom bar)\n- Includes branch pickers, reviewer popover, AI-generation loader\n\n## Testing\n- Open the HTML file in a browser\n- Select target & destination, click Generate, pick reviewers, then Create`;

      if (mode === 'options') {
        prDescription.value += `\n\nOptions prompt\n- ${userPrompt.trim() ? userPrompt.trim() : '(none)'}\nmodel: ${selectedModel}`;
      }

      updateCreateBtn();
    }

    btnCreate.addEventListener('click', async () => {
      createOverlay.classList.add('show');
      const steps = createOverlay.querySelectorAll('.step');
      const totalSteps = steps.length;
      
      for (let i = 0; i < steps.length; i++) {
        const step = steps[i];
        const subSteps = createSubSteps[i];
        const statusEl = step.querySelector('.step-status');
        
        createCounter.textContent = `${i}/${totalSteps}`;
        
        step.classList.add('active');
        step.querySelector('.step-indicator').innerHTML = '<div class="step-spinner"></div>';
        
        for (let j = 0; j < subSteps.length; j++) {
          statusEl.textContent = subSteps[j];
          await new Promise(r => setTimeout(r, 75 + Math.random() * 250));
        }
        
        step.classList.remove('active');
        step.classList.add('done');
        statusEl.textContent = 'done';
        step.querySelector('.step-indicator').innerHTML = '✓';
        
        createCounter.textContent = `${i + 1}/${totalSteps}`;
      }

      await new Promise(r => setTimeout(r, 125));
      createOverlay.classList.remove('show');
      
      steps.forEach(s => {
        s.classList.remove('active', 'done');
        s.querySelector('.step-status').textContent = 'queue';
        s.querySelector('.step-indicator').innerHTML = '';
      });
      createCounter.textContent = '0/4';
    });

    btnCancel.addEventListener('click', () => {
      sourceBranch = 'develop';
      destBranch = 'main';
      selectedReviewers.clear();
      document.getElementById('sourceBranchText').textContent = 'Source: develop';
      document.getElementById('destBranchText').textContent = 'Target: main';
      prTitle.value = '';
      prDescription.value = '';
      updateGenerateBtn();
      updateCreateBtn();
      updateReviewerBadge();
      switchView('pr');
    });

    // Button handlers
    const showOnGitHubBtn = document.getElementById('showOnGitHub');
    const copySHABtn = document.getElementById('copySHA');

    if (showOnGitHubBtn) {
      showOnGitHubBtn.addEventListener('click', () => {
        // Get current commit - assuming currentCommitId is tracked in your app
        // If not, you might need to track it in showCommitDetail
        const commitData = commits[currentCommitId || 0];
        if (commitData && commitData.sha) {
           // Replace with your actual repo URL logic
          window.open(`https://github.com/owner/repo/commit/${commitData.sha}`, '_blank');
        }
      });
    }

    if (copySHABtn) {
      copySHABtn.addEventListener('click', async () => {
        const commitData = commits[currentCommitId || 0];
        if (commitData && commitData.sha) {
          try {
            await navigator.clipboard.writeText(commitData.sha);
            // Visual feedback
            const originalHtml = copySHABtn.innerHTML;
            copySHABtn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> Copied!`;
            setTimeout(() => {
              copySHABtn.innerHTML = originalHtml;
            }, 2000);
          } catch (err) {
            console.error('Failed to copy', err);
          }
        }
      });
    }

    // File detail view button handlers
    ['showInFileBrowser', 'openInIDE', 'showFileOnGitHub'].forEach(id => {
      const btn = document.getElementById(id);
      if (btn) {
        btn.addEventListener('click', () => {
          // Add your action logic here
          console.log(`Action: ${id} for file ${files[0].path}`); // Example

          // Visual feedback
          const originalText = btn.innerHTML;
          btn.innerHTML = '<span>Done!</span>';
          setTimeout(() => btn.innerHTML = originalText, 1000);
        });
      }
    });

    /* --- New Split Button & Menu Logic --- */
    const btnCreateMenuToggle = document.getElementById('btnCreateMenuToggle');
    const createMenuPopover = document.getElementById('createMenuPopover');
    const optCreate = document.getElementById('optCreate');
    const optCreateMerge = document.getElementById('optCreateMerge');
    const generateSteps = document.getElementById('generateSteps');

    // Toggle Menu
    btnCreateMenuToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      createMenuPopover.classList.toggle('show');
    });

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      // Close Create menu
      if (btnCreateMenuToggle && createMenuPopover) {
        if (!btnCreateMenuToggle.contains(e.target) && !createMenuPopover.contains(e.target)) {
          createMenuPopover.classList.remove('show');
        }
      }

      // Close Generate menu
      if (btnGenerateMenuToggle && generateMenuPopover) {
        if (!btnGenerateMenuToggle.contains(e.target) && !generateMenuPopover.contains(e.target)) {
          generateMenuPopover.classList.remove('show');
        }
      }
    });

    // Option 1: Create (Default)
    optCreate.addEventListener('click', () => {
      createMenuPopover.classList.remove('show');
      resetMergeStep(); // Ensure clean state
      btnCreate.click(); // Trigger original logic
    });

    // Option 2: Create and Merge
    optCreateMerge.addEventListener('click', () => {
      createMenuPopover.classList.remove('show');
      addMergeStep(); // Inject the additional merge step
      btnCreate.click(); // Trigger logic
    });

    // Helper to inject the "Merge" step dynamically
    function addMergeStep() {
      if (document.getElementById('step-merge')) return;

      const currentSteps = generateSteps.querySelectorAll('.step').length;
      // Create new step HTML
      const mergeStepHTML = `
        <div class="step" data-step="${currentSteps}" id="step-merge">
          <div class="step-left">
            <div class="step-indicator"></div>
            <span class="step-text">Merging Pull Request...</span>
          </div>
          <div class="step-right">
            <svg class="step-icon spinner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
            </svg>
          </div>
        </div>
      `;
      generateSteps.insertAdjacentHTML('beforeend', mergeStepHTML);

      // Update the counter (e.g., 0/4 -> 0/5)
      const counter = document.getElementById('createCounter');
      if (counter) {
        const [curr, total] = counter.innerText.split('/');
        counter.innerText = `${curr}/${parseInt(total) + 1}`;
      }
    }

    // Helper to remove "Merge" step if switching back to normal create
    function resetMergeStep() {
      const mergeStep = document.getElementById('step-merge');
      if (mergeStep) {
        mergeStep.remove();
        const counter = document.getElementById('createCounter');
        if (counter) {
          const [curr, total] = counter.innerText.split('/');
          counter.innerText = `${curr}/${parseInt(total) - 1}`;
        }
      }
    }

    // Generate split button functions
    function triggerGenerateDefault() {
      if (generateMenuPopover) generateMenuPopover.classList.remove('show');
      // Only generate when user is on PR view; otherwise keep existing "preview" behavior
      if (currentView === 'pr') runGenerateSteps('default');
      else switchView('pr');
    }

    function triggerGenerateWithOptions() {
      if (generateMenuPopover) {
        generateMenuPopover.classList.remove('show');
      }

      // Show prompt popup
      promptOverlay.classList.add('show');

      // Auto-focus the prompt input
      setTimeout(() => {
        promptInput.focus();
      }, 100);
    }

    // Generate split button event handlers
    if (btnGenerateMenuToggle) {
      btnGenerateMenuToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        if (generateMenuPopover) generateMenuPopover.classList.toggle('show');
        // If the Create menu exists, close it when opening this one
        if (typeof createMenuPopover !== 'undefined' && createMenuPopover) {
          createMenuPopover.classList.remove('show');
        }
      });
    }

    if (optGenerateDefault) {
      optGenerateDefault.addEventListener('click', () => {
        triggerGenerateDefault();
      });
    }

    if (optGenerateWithOptions) {
      optGenerateWithOptions.addEventListener('click', () => {
        triggerGenerateWithOptions();
      });
    }

    // Update main button click handler
    btnGenerate.addEventListener('click', () => {
      triggerGenerateDefault();
    });

    // Prompt popup event handlers
    btnPromptCancel.addEventListener('click', () => {
      promptOverlay.classList.remove('show');
      promptInput.value = ''; // Clear input
    });

    btnPromptGenerate.addEventListener('click', () => {
      const userPrompt = promptInput.value.trim();
      const selectedModel = modelSelect.value;

      // Close popup
      promptOverlay.classList.remove('show');

      // Switch to PR view if needed
      if (currentView !== 'pr') {
        switchView('pr');
      }

      // Run generation with prompt and model
      runGenerateSteps('options', userPrompt, selectedModel);

      // Clear input for next time
      promptInput.value = '';
    });

    // Close on Esc key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (promptOverlay.classList.contains('show')) {
          promptOverlay.classList.remove('show');
          promptInput.value = '';
          return;
        }
        // ... existing Esc handling
      }
    });

    // Close on outside click
    promptOverlay.addEventListener('click', (e) => {
      if (e.target === promptOverlay) {
        promptOverlay.classList.remove('show');
        promptInput.value = '';
      }
    });

    // Prevent closing when clicking inside the popup content
    document.querySelector('#promptOverlay .overlay-content').addEventListener('click', (e) => {
      e.stopPropagation();
    });

    // Context Menu for Commits
    const commitContextMenu = document.getElementById('commitContextMenu');
    const ctxCopySha = document.getElementById('ctxCopySha');
    const ctxViewOnGitHub = document.getElementById('ctxViewOnGitHub');
    let contextMenuCommitId = null;

    // Prevent default context menu and show custom one ONLY on commit items
    document.getElementById('commitList').addEventListener('contextmenu', function(e) {
      const commitItem = e.target.closest('.commit-item');
      if (commitItem) {
        e.preventDefault();
        contextMenuCommitId = parseInt(commitItem.dataset.commitId);

        // Position the menu
        commitContextMenu.style.left = e.clientX + 'px';
        commitContextMenu.style.top = e.clientY + 'px';
        commitContextMenu.classList.add('show');

        // Adjust if menu goes off-screen
        const menuRect = commitContextMenu.getBoundingClientRect();
        if (menuRect.right > window.innerWidth) {
          commitContextMenu.style.left = (e.clientX - menuRect.width) + 'px';
        }
        if (menuRect.bottom > window.innerHeight) {
          commitContextMenu.style.top = (e.clientY - menuRect.height) + 'px';
        }
      }
    });

    // Close context menu on click anywhere
    document.addEventListener('click', function() {
      commitContextMenu.classList.remove('show');
    });

    // Close context menu on Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        commitContextMenu.classList.remove('show');
      }
    });

    // Copy SHA action
    ctxCopySha.addEventListener('click', async function() {
      if (contextMenuCommitId !== null) {
        const commit = commits[contextMenuCommitId];
        if (commit && commit.sha) {
          try {
            await navigator.clipboard.writeText(commit.sha);
            // Visual feedback
            const originalText = ctxCopySha.innerHTML;
            ctxCopySha.innerHTML = `
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Copied!
            `;
            setTimeout(() => {
              ctxCopySha.innerHTML = originalText;
            }, 1500);
          } catch (err) {
            console.error('Failed to copy SHA:', err);
          }
        }
      }
      commitContextMenu.classList.remove('show');
    });

    // View on GitHub action
    ctxViewOnGitHub.addEventListener('click', function() {
      if (contextMenuCommitId !== null) {
        const commit = commits[contextMenuCommitId];
        if (commit && commit.sha) {
          // Replace with your actual repo URL
          window.open(`https://github.com/owner/repo/commit/${commit.sha}`, '_blank');
        }
      }
      commitContextMenu.classList.remove('show');
    });

    // ============================================
    // Context Menu for Files (File Overview list)
    // ============================================
    const fileContextMenu = document.getElementById('fileContextMenu');
    const ctxRevealInFileBrowser = document.getElementById('ctxRevealInFileBrowser');
    const ctxFileViewOnGitHub = document.getElementById('ctxFileViewOnGitHub');
    const ctxOpenWithDefault = document.getElementById('ctxOpenWithDefault');
    const ctxCopyFilePath = document.getElementById('ctxCopyFilePath');
    let contextMenuFileId = null;

    // Prevent default context menu and show custom one ONLY on file items in sidebar
    document.getElementById('fileList').addEventListener('contextmenu', function(e) {
      const fileItem = e.target.closest('.file-item');
      if (fileItem) {
        e.preventDefault();
        contextMenuFileId = parseInt(fileItem.dataset.fileId);

        // Close commit context menu if open
        commitContextMenu.classList.remove('show');

        // Position the menu
        fileContextMenu.style.left = e.clientX + 'px';
        fileContextMenu.style.top = e.clientY + 'px';
        fileContextMenu.classList.add('show');

        // Adjust if menu goes off-screen
        const menuRect = fileContextMenu.getBoundingClientRect();
        if (menuRect.right > window.innerWidth) {
          fileContextMenu.style.left = (e.clientX - menuRect.width) + 'px';
        }
        if (menuRect.bottom > window.innerHeight) {
          fileContextMenu.style.top = (e.clientY - menuRect.height) + 'px';
        }
      }
    });

    // Close file context menu on click anywhere
    document.addEventListener('click', function() {
      fileContextMenu.classList.remove('show');
    });

    // Close file context menu on Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        fileContextMenu.classList.remove('show');
      }
    });

    // Reveal in file-browser action
    ctxRevealInFileBrowser.addEventListener('click', function() {
      if (contextMenuFileId !== null) {
        const file = files[contextMenuFileId];
        if (file && file.path) {
          // In a real app, this would trigger a native file browser reveal
          // For web demo, we show feedback
          console.log('Reveal in file-browser:', file.path);
          showContextMenuFeedback(ctxRevealInFileBrowser, 'Opening...');
        }
      }
      fileContextMenu.classList.remove('show');
    });

    // View on GitHub action
    ctxFileViewOnGitHub.addEventListener('click', function() {
      if (contextMenuFileId !== null) {
        const file = files[contextMenuFileId];
        if (file && file.path) {
          // Replace with your actual repo URL
          const branch = sourceBranch || 'main';
          window.open(`https://github.com/owner/repo/blob/${branch}/${file.path}`, '_blank');
        }
      }
      fileContextMenu.classList.remove('show');
    });

    // Open with default program action
    ctxOpenWithDefault.addEventListener('click', function() {
      if (contextMenuFileId !== null) {
        const file = files[contextMenuFileId];
        if (file && file.path) {
          // In a real app, this would trigger the OS default handler
          console.log('Open with default program:', file.path);
          showContextMenuFeedback(ctxOpenWithDefault, 'Opening...');
        }
      }
      fileContextMenu.classList.remove('show');
    });

    // Copy file path action
    ctxCopyFilePath.addEventListener('click', async function() {
      if (contextMenuFileId !== null) {
        const file = files[contextMenuFileId];
        if (file && file.path) {
          try {
            await navigator.clipboard.writeText(file.path);
            showContextMenuFeedback(ctxCopyFilePath, 'Copied!');
          } catch (err) {
            console.error('Failed to copy file path:', err);
          }
        }
      }
      fileContextMenu.classList.remove('show');
    });

    // Helper function for visual feedback on context menu items
    function showContextMenuFeedback(element, message) {
      const originalHTML = element.innerHTML;
      element.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        ${message}
      `;
      setTimeout(() => {
        element.innerHTML = originalHTML;
      }, 1500);
    }

    // Update the existing click handler to close ALL context menus
    document.addEventListener('click', function() {
      commitContextMenu.classList.remove('show');
      fileContextMenu.classList.remove('show');
    });

    // Update the existing keydown handler to close ALL context menus
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        commitContextMenu.classList.remove('show');
        fileContextMenu.classList.remove('show');
      }
    });

    // Bind copy-to-clipboard behavior for inline SHA copy buttons
    document.addEventListener("click", async (e) => {
      const btn = e.target.closest(".js-copy-commit-sha");
      if (!btn) return;

      const sha = btn.dataset.sha || "";
      if (!sha) return;

      try {
        await navigator.clipboard.writeText(sha);

        // Optional tiny feedback
        btn.style.transform = "scale(0.95)";
        setTimeout(() => (btn.style.transform = ""), 120);
      } catch (err) {
        console.error("Failed to copy SHA:", err);
      }
    });

    // Initialize
    renderReviewerList();
    updateReviewerBadge();
    updateGenerateBtn();
    updateCreateBtn();
  </script>

</body>
</html>
