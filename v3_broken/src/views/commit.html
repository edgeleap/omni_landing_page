<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Omni — Commit</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-primary: #0a0a0a;
      --bg-secondary: #09090b;
      --bg-tertiary: #141414;
      --bg-hover: #1a1a1a;
      --border: #27272a;
      --border-light: #3f3f46;
      --text-primary: #fafafa;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --accent: #fafafa;
      --accent-dim: rgba(255,255,255,0.08);
      --green: #22c55e;
      --amber: #f59e0b;
      --orange: #fb923c;
      --red: #ef4444;
      --shadow: 0 25px 50px -12px rgba(0,0,0,0.65);
      --mono: 'JetBrains Mono', ui-monospace, monospace;
      --sans: 'Inter', ui-sans-serif, system-ui, sans-serif;
      --radius: 10px;
      --focus-ring: rgba(255,255,255,0.08);
      --kbd-bg: rgba(255,255,255,0.05);
      --split-separator: rgba(113,113,122,0.4);
      --btn-primary-hover: #e4e4e7;
      --btn-primary-text: #0a0a0a;
    }

    html, body { height: 100%; }
    body {
      background: radial-gradient(1100px 700px at 70% 20%, rgba(255,255,255,0.04), transparent 60%),
                  radial-gradient(900px 650px at 15% 75%, rgba(34,197,94,0.04), transparent 62%),
                  linear-gradient(180deg, #000, #0a0a0a);
      color: var(--text-primary);
      font-family: var(--sans);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      pointer-events: none;
      background: repeating-linear-gradient(to bottom, rgba(255,255,255,0.012), rgba(255,255,255,0.012) 1px, rgba(0,0,0,0) 3px, rgba(0,0,0,0) 6px);
      mix-blend-mode: overlay;
      opacity: 0.18;
      z-index: 9999;
    }

    ::selection { background: rgba(255,255,255,0.2); }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #52525b; }

    /* Main Window */
    .window {
      width: 100%;
      max-width: 1100px;
      height: min(680px, calc(100vh - 60px));
      background: rgba(9,9,11,0.88);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      backdrop-filter: blur(12px);
    }

    /* Status Bar */
    .status-bar {
      height: 44px;
      padding: 0 14px;
      border-bottom: 1px solid var(--border);
      background: rgba(0,0,0,0.35);
      display: flex;
      align-items: center;
      flex-shrink: 0;
    }

    .traffic-lights { display: flex; gap: 8px; }
    .traffic-light {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    .traffic-light.red { background: #ff5f57; }
    .traffic-light.yellow { background: #febc2e; }
    .traffic-light.green { background: #28c840; }
    .traffic-light:hover { filter: brightness(1.15); transform: scale(1.1); }

    .status-title {
      flex: 1;
      text-align: center;
      font-size: 13px;
      font-family: var(--mono);
      color: var(--text-muted);
      letter-spacing: 0.02em;
    }

    .status-spacer { width: 52px; }

    /* Buttons */
    .btn {
      font-family: var(--sans);
      font-size: 13px;
      font-weight: 500;
      padding: 8px 14px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.22);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.15s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select: none;
    }
    .btn:hover { background: var(--bg-hover); border-color: var(--border-light); }
    .btn:active { transform: translateY(1px); }
    .btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      pointer-events: none;
    }

    .btn-primary {
      background: var(--text-primary);
      color: var(--btn-primary-text);
      border-color: transparent;
    }
    .btn-primary:hover { background: var(--btn-primary-hover); }

    .btn-ghost {
      background: transparent;
      border-color: transparent;
    }
    .btn-ghost:hover { background: var(--accent-dim); border-color: var(--border); }

    .btn .icon { width: 14px; height: 14px; opacity: 0.7; }
    .btn .chevron { width: 12px; height: 12px; opacity: 0.5; margin-left: auto; }

    /* Split Button - matching styleguide */
    .split-btn-container { 
      display: inline-flex; 
      position: relative; 
      vertical-align: middle; 
    }
    .split-btn-container .btn { margin: 0; }
    .split-btn-container:hover .btn:not(:disabled) {
      background: var(--btn-primary-hover);
      border-color: var(--border-light);
      color: var(--btn-primary-text);
    }
    .split-btn-container:active .btn:not(:disabled) { transform: translateY(1px); }

    .btn-split-left {
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
      border-right: none;
      padding-right: 12px;
      position: relative;
    }
    .btn-split-left::after {
      content: "";
      position: absolute;
      right: 0;
      top: 20%;
      height: 60%;
      width: 1px;
      background: var(--split-separator);
      z-index: 1;
    }
    .btn-split-right {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
      border-left: none;
      padding-left: 8px;
      padding-right: 8px;
      width: 36px;
      justify-content: center;
    }
    .btn-split-right svg { width: 16px; height: 16px; }

    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* Left Sidebar */
    .sidebar {
      width: 280px;
      border-right: 1px solid var(--border);
      background: rgba(0,0,0,0.16);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow: hidden;
    }

    .sidebar-section {
      padding: 12px;
      border-bottom: 1px solid rgba(39,39,42,0.5);
    }
    .sidebar-section:first-child { padding-top: 14px; }
    .sidebar-section:last-child { border-bottom: none; }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .section-header .label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
    }
    .section-header .meta {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Checkbox - matching styleguide */
    .checkbox {
      width: 16px;
      height: 16px;
      appearance: none;
      -webkit-appearance: none;
      border: 1.5px solid var(--border-light);
      border-radius: 4px;
      background: var(--bg-primary);
      cursor: pointer;
      position: relative;
      flex-shrink: 0;
      transition: all 0.15s ease;
    }
    .checkbox:hover { border-color: var(--text-muted); }
    .checkbox:checked {
      background: var(--text-primary);
      border-color: var(--text-primary);
    }
    .checkbox:checked::after {
      content: "✓";
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--bg-primary);
      font-size: 10px;
      font-weight: bold;
    }
    .checkbox:focus {
      outline: none;
      box-shadow: 0 0 0 3px var(--focus-ring);
    }

    /* Checkbox subtle variant (stroke-only) */
    .checkbox-subtle {
      width: 16px;
      height: 16px;
      appearance: none;
      -webkit-appearance: none;
      border: 1px solid var(--border-light);  /* thinner: 1px instead of 1.5px */
      border-radius: 4px;
      background: transparent;
      cursor: pointer;
      position: relative;
      flex-shrink: 0;
      transition: all 0.15s ease;
    }
    .checkbox-subtle:hover {
      border-color: var(--text-secondary);  /* brighter hover */
    }
    .checkbox-subtle:checked {
      border-color: var(--text-primary);  /* full brightness */
      background: transparent;
    }
    .checkbox-subtle:checked::after {
      content: "✓";
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);  /* full brightness checkmark */
      font-size: 10px;
      font-weight: bold;
    }
    .checkbox-subtle:focus {
      outline: none;
      box-shadow: 0 0 0 3px var(--focus-ring);
    }

    /* File Item */
    .file-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 8px;
      border-radius: 6px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text-secondary);
      transition: background 0.15s;
      cursor: pointer;
    }
    .file-item:hover { background: var(--bg-hover); }
    .file-item.active { background: var(--accent-dim); }

    .file-status {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .file-status.M { background: rgba(245,158,11,0.18); color: var(--amber); }
    .file-status.A { background: rgba(34,197,94,0.18); color: var(--green); }
    .file-status.R { background: rgba(239,68,68,0.18); color: var(--red); }

    /* File drawer items - status on left side */
    .detail-files-grid .file-status {
      order: -1;
      margin-right: 8px;
      margin-left: 0;
    }

    /* Sidebar file items - status on right side */
    #fileList .file-status {
      order: 1;
      margin-left: 8px;
      margin-right: 0;
    }

    .file-path {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .file-changes {
      font-size: 10px;
      color: var(--text-muted);
      white-space: nowrap;
    }
    .file-changes .add { color: var(--green); }
    .file-changes .rem { color: var(--red); }

    /* Commit Item */
    .commit-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-secondary);
      transition: background 0.15s;
      cursor: pointer;
    }
    .commit-item:hover { background: var(--accent-dim); }
    .commit-item.active { background: var(--accent-dim); }
    .commit-item .checkbox { margin-top: 3px; }
    .commit-item .commit-info { flex: 1; min-width: 0; }
    .commit-item .commit-title {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text-secondary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .commit-item .commit-subtitle {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .empty-state {
      padding: 16px 12px;
      text-align: center;
      font-size: 12px;
      color: var(--text-muted);
      font-style: italic;
    }

    /* Details Panel */
    .details-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      background: rgba(0,0,0,0.08);
    }

    .top-bar {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: rgba(0,0,0,0.18);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      flex-shrink: 0;
    }

    .details-content-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      overflow-y: auto;
    }

    .form-group { margin-bottom: 20px; }
    .form-group.flex-grow {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      background: rgba(0,0,0,0.25);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 14px;
      font-family: var(--sans);
      font-size: 13px;
      color: var(--text-primary);
      transition: border-color 0.2s;
    }
    .form-input:focus { outline: none; border-color: var(--border-light); }
    .form-input::placeholder { color: var(--text-muted); }

    textarea.form-input {
      flex: 1;
      min-height: 140px;
      resize: none;
      font-family: var(--mono);
      line-height: 1.6;
    }

    /* KBD - matching styleguide */
    .kbd {
      padding: 2px 6px;
      background: var(--kbd-bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, var(--mono), monospace;
      color: var(--text-secondary);
      display: inline-block;
      vertical-align: baseline;
    }

    /* Shortcuts bar - matching styleguide */
    .shortcuts-bar {
      display: flex;
      align-items: center;
      gap: 16px;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-muted);
    }
    .shortcuts-bar .shortcut {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .shortcuts-bar .shortcut .kbd {
      margin-right: 2px;
    }

    /* Menu shortcut - matching styleguide */
    .menu-shortcut {
      font-size: 11px;
      color: var(--text-muted);
      font-family: var(--mono);
      margin-left: 12px;
      white-space: nowrap;
      flex-shrink: 0;
      align-self: flex-start;
      margin-top: 2px;
    }
    .menu-shortcut .kbd {
      margin-right: 3px;
    }
    .menu-shortcut .kbd:last-child {
      margin-right: 0;
    }

    /* Detail Views */
    .detail-view {
      display: none;
      flex-direction: column;
      height: 100%;
    }
    .detail-view.active { display: flex; }

    /* Bottom Bar */
    .bottom-bar {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: rgba(0,0,0,0.22);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-shrink: 0;
    }

    .bottom-bar-right {
      display: flex;
      gap: 10px;
    }

    /* Dropdown */
    .dropdown-container { position: relative; }

    .dropdown {
      display: none;
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      min-width: 280px;
      background: rgba(9,9,11,0.96);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      z-index: 100;
      overflow: hidden;
    }
    .dropdown.show { display: block; }

    .dropdown-header {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      background: rgba(0,0,0,0.25);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .dropdown-header .branch-count {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 400;
    }

    .dropdown-search {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      position: relative;
    }

    .dropdown-search input {
      width: 100%;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 32px 8px 12px;
      font-size: 12px;
      color: var(--text-primary);
    }
    .dropdown-search input:focus { outline: none; border-color: var(--border-light); }
    .dropdown-search input::placeholder { color: var(--text-muted); }

    .clear-btn {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      display: none;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.15s;
    }
    .clear-btn:hover { background: var(--accent-dim); color: var(--text-secondary); }
    .clear-btn.show { display: flex; }
    .clear-btn svg { width: 14px; height: 14px; }

    .dropdown-list {
      max-height: 240px;
      overflow-y: auto;
      padding: 6px;
    }

    .dropdown-item {
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.12s;
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: space-between;
    }
    .dropdown-item:hover { background: var(--accent-dim); color: var(--text-primary); }
    .dropdown-item.selected { background: var(--accent-dim); color: var(--text-primary); }

    .branch-current-indicator {
      font-size: 11px;
      color: var(--text-muted);
      font-family: var(--mono);
      margin-left: auto;
      padding-left: 8px;
    }

    /* Overlay */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.70);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }
    .overlay.show { display: flex; }

    .overlay-content {
      background: rgba(9,9,11,0.95);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      width: min(520px, calc(100vw - 36px));
      overflow: hidden;
    }

    .overlay-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: rgba(0,0,0,0.25);
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .overlay-header-counter {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 400;
    }

    .overlay-body { padding: 12px 16px; }

    /* Progress Steps */
    .progress-steps {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .step {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 8px 0px;
      border-radius: 12px;
      background: transparent;
      border: none;
      font-family: var(--mono);
      font-size: 12.5px;
      color: var(--text-primary);
      transition: all 0.2s;
    }
    .step.done { color: var(--text-secondary); background: transparent; }

    .step-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }

    .step-indicator {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      flex-shrink: 0;
      position: relative;
      font-family: system-ui, -apple-system, sans-serif;
      font-weight: 400;
    }
    .step.active .step-indicator { border-color: rgba(251, 146, 60, 0.3); }
    .step.done .step-indicator {
      border-color: var(--green);
      background: rgba(34,197,94,0.15);
      color: var(--green);
    }

    .step-spinner {
      position: absolute;
      inset: -2px;
      border-radius: 50%;
      border: 2px solid rgba(251, 146, 60, 0.25);
      border-top-color: rgba(251, 146, 60, 0.9);
      animation: spin 0.8s linear infinite;
    }

    .step-text {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .step-status {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text-muted);
      flex-shrink: 0;
      min-width: 180px;
      text-align: right;
    }
    .step.active .step-status { color: var(--orange); }
    .step.done .step-status { color: var(--green); }

    @keyframes spin { to { transform: rotate(360deg); } }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.96); }
      to { opacity: 1; transform: scale(1); }
    }
    .overlay.show .overlay-content { animation: fadeIn 0.22s ease; }

    /* Popover Menu */
    .popover-menu {
      position: absolute;
      bottom: 100%;
      right: 0;
      margin-bottom: 8px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      width: 380px;
      height: 140px;
      min-width: 250px;
      display: none;
      z-index: 1000;
      overflow: hidden;
      flex-direction: column;
    }
    .popover-menu.show { display: flex; }
    .popover-menu.popover-down {
      bottom: auto;
      top: 100%;
      margin-top: 8px;
      margin-bottom: 0;
    }

    .menu-item {
      padding: 12px 16px;
      font-size: 14px;
      cursor: pointer;
      color: var(--text-primary);
      transition: background 0.2s;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }
    .menu-item:hover { background: var(--bg-hover); }

    .menu-item span.desc {
      display: block;
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
      white-space: normal;
      line-height: 1.4;
    }

    /* Context Menu */
    .context-menu {
      position: fixed;
      background: rgba(9,9,11,0.96);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      min-width: 180px;
      z-index: 1000;
      display: none;
      overflow: hidden;
    }
    .context-menu.show { display: block; }

    .context-menu-item {
      padding: 10px 14px;
      font-size: 13px;
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.15s;
    }
    .context-menu-item:hover { background: var(--bg-hover); }
    .context-menu-item svg { width: 14px; height: 14px; opacity: 0.7; }

    .context-menu-separator {
      height: 1px;
      background: var(--border);
      margin: 4px 0;
    }

    /* Prompt overlay */
    .prompt-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
      line-height: 1.5;
    }

    .prompt-input {
      width: 100%;
      background: rgba(0,0,0,0.25);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 14px;
      font-family: var(--sans);
      font-size: 13px;
      color: var(--text-primary);
      resize: vertical;
      min-height: 120px;
      margin-bottom: 16px;
    }
    .prompt-input:focus { outline: none; border-color: var(--border-light); }

    .model-selector {
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .model-selector .form-label { margin-bottom: 0; min-width: 50px; }
    .model-selector .form-input {
      flex: 1;
      margin-bottom: 0;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23a1a1aa' stroke-width='2'%3e%3cpolyline points='6 9 12 15 18 9'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 12px;
      padding-right: 30px;
      background-color: rgba(0,0,0,0.25);
    }

    .prompt-actions {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: rgba(0,0,0,0.22);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* Autosplit toggle row */
    .autosplit-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
      user-select: none;
      cursor: pointer;
    }

    /* File drawer - matching styleguide */
    .detail-files {
      border-top: 1px solid var(--border);
      padding-top: 12px;
      margin-top: auto;
    }

    .detail-files-header {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .detail-files-stats {
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 500;
      color: var(--text-muted);
      opacity: 0.7;
      text-transform: none;
      letter-spacing: normal;
      display: flex;
      gap: 12px;
    }

    .detail-files-stats .add { color: var(--green); }
    .detail-files-stats .rem { color: var(--red); }

    .detail-files-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .detail-files-grid .file-item {
      flex: 0 0 auto;
      min-width: 0;
      background: var(--bg-tertiary);
      text-transform: none;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-muted);
      opacity: 0.8;
    }

    /* Code preview box */
    .code-box {
      flex: 1;
      min-height: 0;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.18);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      background: rgba(0,0,0,0.12);
    }
    .code-path {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text-primary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .code-meta {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-muted);
    }
    .code-content {
      flex: 1;
      overflow: auto;
      padding: 12px 14px;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.6;
      color: var(--text-secondary);
      white-space: pre;
    }
    .code-content .ln {
      color: var(--text-muted);
      user-select: none;
      display: inline-block;
      width: 3ch;
      text-align: right;
      margin-right: 12px;
      opacity: 0.6;
    }

    /* Placeholder state */
    .placeholder-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      text-align: center;
    }
    .placeholder-state .title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    .placeholder-state .desc {
      font-size: 12px;
      color: var(--text-muted);
      font-family: var(--mono);
      line-height: 1.5;
      white-space: pre-wrap;
    }

    /* Character count colors */
    .char-count { transition: color 0.15s; }
    .char-count.warning { color: var(--amber); }
    .char-count.danger { color: var(--red); }
  </style>
</head>
<body>

  <!-- Main Window -->
  <div class="window">

    <!-- Status Bar -->
    <div class="status-bar">
      <div class="traffic-lights" aria-hidden="true">
        <div class="traffic-light red"></div>
        <div class="traffic-light yellow"></div>
        <div class="traffic-light green"></div>
      </div>
      <div class="status-title">Omni — Commit</div>
      <div class="status-spacer"></div>
    </div>

    <!-- Main Content -->
    <div class="main-content">

      <!-- Left Sidebar -->
      <aside class="sidebar">

        <!-- File Changes -->
        <div class="sidebar-section" style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
          <div class="section-header">
            <span class="label">File changes</span>
            <span class="meta" id="fileCount">0 Files</span>
          </div>
          <div style="margin-bottom:10px;">
            <div class="dropdown-search" style="padding:0; border:none;">
              <input type="text" id="fileFilter" placeholder="Filter files..." />
              <button class="clear-btn" id="fileFilterClear" aria-label="Clear">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
          </div>
          <div id="fileList" style="flex:1; overflow-y:auto;"></div>
        </div>

        <!-- Proposed Commits (hidden until generate) -->
        <div class="sidebar-section" id="commitsSection" style="display:none; flex:1; overflow:hidden; flex-direction:column;">
          <div class="section-header">
            <span class="label">Proposed commits</span>
            <span class="meta" id="commitCount">0 / 0</span>
          </div>
          <div id="commitList" style="flex:1; overflow-y:auto;"></div>
        </div>

      </aside>

      <!-- Details Panel -->
      <section class="details-panel">

        <!-- Top Bar -->
        <div class="top-bar">
          <label class="autosplit-row" id="autosplitToggle">
            <input type="checkbox" class="checkbox" id="autosplitCheck" checked />
            <span>Auto-split commits</span>
          </label>

          <div style="flex:1;"></div>

          <!-- Branch selector -->
          <div class="dropdown-container">
            <button class="btn" id="btnBranch">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="6" y1="3" x2="6" y2="15"></line>
                <circle cx="18" cy="6" r="3"></circle>
                <circle cx="6" cy="18" r="3"></circle>
                <path d="M18 9a9 9 0 0 1-9 9"></path>
              </svg>
              <span>Branch: <span id="branchLabel">main</span></span>
              <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
            <div class="dropdown" id="branchDropdown">
              <div class="dropdown-header">
                <span>Select branch</span>
                <span class="branch-count" id="branchCount">7</span>
              </div>
              <div class="dropdown-search">
                <input type="text" id="branchFilter" placeholder="Filter branches..." />
                <button class="clear-btn" id="branchFilterClear" aria-label="Clear">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
              <div class="dropdown-list" id="branchList"></div>
            </div>
          </div>

          <!-- Generate split button -->
          <div class="split-btn-container" id="generateContainer">
            <button class="btn btn-primary btn-split-left" id="btnGenerate" disabled>Generate commit</button>
            <button class="btn btn-primary btn-split-right" id="btnGenerateMenuToggle" disabled aria-label="More options">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
            <div class="popover-menu popover-down" id="generateMenu">
              <div class="menu-item" id="miGenerate">
                <div>
                  Generate commit
                  <span class="desc">Generate commits based on the current file changes</span>
                </div>
                <span class="menu-shortcut"><span class="kbd">⌘</span><span class="kbd">G</span></span>
              </div>
              <div class="menu-item" id="miGeneratePrompt">
                <div>
                  Generate with prompt
                  <span class="desc">Provide additional context for more accurate messages</span>
                </div>
                <span class="menu-shortcut"><span class="kbd">⇧</span><span class="kbd">⌘</span><span class="kbd">G</span></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Details Content Area -->
        <div class="details-content-area">

          <!-- Placeholder -->
          <div class="placeholder-state" id="placeholder">
            <div class="title">Nothing selected</div>
            <div class="desc">Select a file on the left to inspect details.</div>
          </div>

          <!-- File view -->
          <div class="detail-view" id="fileView">
            <div class="code-box">
              <div class="code-header">
                <span class="code-path" id="codePath"></span>
                <span class="code-meta" id="codeMeta"></span>
              </div>
              <div class="code-content" id="codeContent"></div>
            </div>
          </div>

          <!-- Commit editor view -->
          <div class="detail-view" id="commitView">
            <div class="form-group">
              <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:8px;">
                <label class="form-label" style="margin-bottom:0;">Title</label>
                <span class="char-count" id="titleCount" style="font-family:var(--mono); font-size:11px; color:var(--text-muted);">0 chars</span>
              </div>
              <input type="text" class="form-input" id="titleInput" placeholder="e.g., feat: add user authentication…" />
            </div>

            <div class="form-group flex-grow">
              <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:8px;">
                <label class="form-label" style="margin-bottom:0;">Description</label>
                <span id="bodyCount" style="font-family:var(--mono); font-size:11px; color:var(--text-muted);">0 chars</span>
              </div>
              <textarea class="form-input" id="bodyInput" placeholder="Why this change? Link issues or add context…"></textarea>
            </div>

            <div class="detail-files">
              <div class="detail-files-header">
                <span>Files in commit</span>
                <span class="detail-files-stats" id="fileStats">
                  <span id="fileCountStats">0 files</span>
                  <span class="add" id="insertionStats">+0 insertions</span>
                  <span class="rem" id="deletionStats">−0 deletions</span>
                </span>
              </div>
              <div class="detail-files-grid" id="fileGrid"></div>
            </div>
          </div>

        </div>

      </section>

    </div>

    <!-- Bottom Bar -->
    <div class="bottom-bar">
      <div class="shortcuts-bar">
        <span class="shortcut"><span class="kbd">Esc</span> Cancel</span>
        <span class="shortcut"><span class="kbd">⏎</span> Commit</span>
        <span class="shortcut"><span class="kbd">⇧</span><span class="kbd">⏎</span> Commit & Push</span>
      </div>
      <div class="bottom-bar-right">
        <button class="btn" id="btnCancel">Cancel</button>
        <div class="split-btn-container" id="commitContainer">
          <button class="btn btn-primary btn-split-left" id="btnCommit" disabled>Commit</button>
          <button class="btn btn-primary btn-split-right" id="btnCommitMenuToggle" disabled aria-label="More options">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          <div class="popover-menu" id="commitMenu">
            <div class="menu-item" id="miCommit">
              <div>Commit<span class="desc">Create a local commit</span></div>
              <span class="menu-shortcut"><span class="kbd">⏎</span></span>
            </div>
            <div class="menu-item" id="miCommitPush">
              <div>Commit & Push<span class="desc">Create commit and push to remote</span></div>
              <span class="menu-shortcut"><span class="kbd">⇧</span><span class="kbd">⏎</span></span>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Generate Progress Overlay -->
  <div class="overlay" id="generateOverlay">
    <div class="overlay-content">
      <div class="overlay-header">
        <span>Generating Commit</span>
        <span class="overlay-header-counter" id="genCounter">0/4</span>
      </div>
      <div class="overlay-body">
        <div class="progress-steps" id="generateSteps">
          <div class="step" data-step="0">
            <div class="step-left">
              <div class="step-indicator"></div>
              <span class="step-text">Analyzing selected files</span>
            </div>
            <span class="step-status">queue</span>
          </div>
          <div class="step" data-step="1">
            <div class="step-left">
              <div class="step-indicator"></div>
              <span class="step-text">Detecting logical groupings</span>
            </div>
            <span class="step-status">queue</span>
          </div>
          <div class="step" data-step="2">
            <div class="step-left">
              <div class="step-indicator"></div>
              <span class="step-text">Generating commit message</span>
            </div>
            <span class="step-status">queue</span>
          </div>
          <div class="step" data-step="3">
            <div class="step-left">
              <div class="step-indicator"></div>
              <span class="step-text">Finalizing commit</span>
            </div>
            <span class="step-status">queue</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Commit Progress Overlay -->
  <div class="overlay" id="commitOverlay">
    <div class="overlay-content">
      <div class="overlay-header">
        <span id="commitOverlayTitle">Committing changes</span>
        <span class="overlay-header-counter" id="commitCounter">0/4</span>
      </div>
      <div class="overlay-body">
        <div class="progress-steps" id="commitSteps">
          <div class="step" data-step="0">
            <div class="step-left">
              <div class="step-indicator"></div>
              <span class="step-text">Finalizing commit</span>
            </div>
            <span class="step-status">queue</span>
          </div>
          <div class="step" data-step="1">
            <div class="step-left">
              <div class="step-indicator"></div>
              <span class="step-text">Creating commit objects</span>
            </div>
            <span class="step-status">queue</span>
          </div>
          <div class="step" data-step="2">
            <div class="step-left">
              <div class="step-indicator"></div>
              <span class="step-text">Connecting to GitHub</span>
            </div>
            <span class="step-status">queue</span>
          </div>
          <div class="step" data-step="3">
            <div class="step-left">
              <div class="step-indicator"></div>
              <span class="step-text">Sending commit payload</span>
            </div>
            <span class="step-status">queue</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Prompt Overlay -->
  <div class="overlay" id="promptOverlay">
    <div class="overlay-content">
      <div class="overlay-header">
        <span>Generate with prompt</span>
        <button class="btn btn-ghost" id="promptClose" style="padding:4px 8px;">✕</button>
      </div>
      <div class="overlay-body">
        <p class="prompt-subtitle">Provide additional context to generate more accurate commit messages.</p>
        <textarea class="prompt-input" id="promptInput" placeholder="What should these commits emphasize or avoid? (scope, split, tone, issue links)."></textarea>
        <div class="model-selector">
          <label class="form-label">Model</label>
          <select class="form-input" id="modelSelect">
            <option value="gpt-4o" selected>GPT-4o (Default)</option>
            <option value="gpt-4-turbo">GPT-4 Turbo</option>
            <option value="claude-3-5-sonnet">Claude 3.5 Sonnet</option>
            <option value="claude-3-opus">Claude 3 Opus</option>
            <option value="gemini-pro">Gemini Pro</option>
          </select>
        </div>
      </div>
      <div class="prompt-actions">
        <button class="btn" id="promptCancel">Cancel</button>
        <button class="btn btn-primary" id="promptGenerate">Generate</button>
      </div>
    </div>
  </div>

  <!-- Context Menu -->
  <div class="context-menu" id="contextMenu">
    <div class="context-menu-item" id="ctxCopyPath">Copy file path</div>
    <div class="context-menu-item" id="ctxOpenBrowser">Open in file browser</div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" id="ctxCheckAll">Check all</div>
    <div class="context-menu-item" id="ctxUncheckAll">Uncheck all</div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" id="ctxCheckSelected">Check selected</div>
    <div class="context-menu-item" id="ctxUncheckSelected">Uncheck selected</div>
  </div>

  <script>
    // === Data ===
    const branches = ['main', 'develop', 'release/v1.2.0', 'feature/commit-generator', 'feature/auth-session', 'bugfix/ui-spacing', 'chore/deps'];
    let currentBranch = 'main';

    const fileData = [
      { id:'f1', path:'src/auth/login.ts', delta:'+84 -12', status:'M', checked:true, selected:false },
      { id:'f2', path:'src/auth/session.ts', delta:'+51 -8', status:'M', checked:true, selected:false },
      { id:'f3', path:'src/api/client.ts', delta:'+33 -6', status:'M', checked:true, selected:false },
      { id:'f4', path:'src/ui/Button.tsx', delta:'+22 -2', status:'M', checked:true, selected:false },
      { id:'f5', path:'src/ui/Toast.tsx', delta:'+18 -0', status:'M', checked:true, selected:false },
      { id:'f6', path:'README.md', delta:'+9 -1', status:'M', checked:true, selected:false },
      { id:'f7', path:'tests/auth.spec.ts', delta:'+44 -3', status:'A', checked:true, selected:false },
      { id:'f8', path:'docs/old.md', delta:'+0 -17', status:'R', checked:true, selected:false }
    ];

    const fileContents = {
      f1: ["import createClient from '../api/client';", "import validateLogin from './validation';", "", "export async function login(email: string, password: string) {", "  const ok = validateLogin(email, password);", "  if (!ok) throw new Error('Invalid credentials');", "  const client = createClient();", "  const res = await client.post('/login', { email, password });", "  return res.data;", "}"],
      f5: ["import { useEffect, useState } from 'react';", "", "type ToastProps = { id: string; title: string; body?: string };", "", "export function Toast({ title, body }: ToastProps) {", "  const [open, setOpen] = useState(true);", "  useEffect(() => {", "    const t = setTimeout(() => setOpen(false), 3800);", "    return () => clearTimeout(t);", "  }, []);", "", "  if (!open) return null;", "  return (", "    <div className='toast'>", "      <div className='title'>{title}</div>", "      {body ? <div className='body'>{body}</div> : null}", "    </div>", "  );", "}"],
      f8: ["Deprecated", "", "This document has been removed.", "Please refer to docs/new.md instead."]
    };

    const commitData = [
      { id:'c1', title:'feat(auth): introduce login+session wiring', subtitle:'4 files · +156 · -22', checked:true, selected:false, body:'- Summary: Create a minimal login session flow.\n- Notes: Keeps scope tight and reviewable.', files:['f1','f2','f4','f6'] },
      { id:'c2', title:'refactor(api): isolate client route composition', subtitle:'1 file · +33 · -6', checked:true, selected:false, body:'- Summary: Separate API client from routing layer.\n- Notes: No behavior change intended.', files:['f3'] },
      { id:'c3', title:'test(auth): cover login happy-path', subtitle:'1 file · +44 · -0', checked:true, selected:false, body:'- Summary: Add baseline coverage for login/session.\n- Notes: Focused on the green path only.', files:['f7'] }
    ];

    let commitsVisible = false;
    let lastFileIndex = null;
    let lastCommitIndex = null;

    // === DOM refs ===
    const fileListEl = document.getElementById('fileList');
    const fileCountEl = document.getElementById('fileCount');
    const fileFilterEl = document.getElementById('fileFilter');
    const fileFilterClearEl = document.getElementById('fileFilterClear');
    const commitListEl = document.getElementById('commitList');
    const commitCountEl = document.getElementById('commitCount');
    const commitsSectionEl = document.getElementById('commitsSection');

    const placeholder = document.getElementById('placeholder');
    const fileView = document.getElementById('fileView');
    const commitView = document.getElementById('commitView');
    const codePath = document.getElementById('codePath');
    const codeMeta = document.getElementById('codeMeta');
    const codeContent = document.getElementById('codeContent');
    const titleInput = document.getElementById('titleInput');
    const titleCount = document.getElementById('titleCount');
    const bodyInput = document.getElementById('bodyInput');
    const bodyCount = document.getElementById('bodyCount');
    const chipsEl = document.getElementById('chips');
    const chipsMeta = document.getElementById('chipsMeta');

    const btnBranch = document.getElementById('btnBranch');
    const branchLabel = document.getElementById('branchLabel');
    const branchDropdown = document.getElementById('branchDropdown');
    const branchFilter = document.getElementById('branchFilter');
    const branchFilterClear = document.getElementById('branchFilterClear');
    const branchList = document.getElementById('branchList');
    const branchCountEl = document.getElementById('branchCount');

    const btnGenerate = document.getElementById('btnGenerate');
    const btnGenerateMenuToggle = document.getElementById('btnGenerateMenuToggle');
    const generateMenu = document.getElementById('generateMenu');
    const generateOverlay = document.getElementById('generateOverlay');
    const genCounter = document.getElementById('genCounter');

    const btnCommit = document.getElementById('btnCommit');
    const btnCommitMenuToggle = document.getElementById('btnCommitMenuToggle');
    const commitMenu = document.getElementById('commitMenu');
    const commitOverlay = document.getElementById('commitOverlay');
    const commitCounter = document.getElementById('commitCounter');
    const commitOverlayTitle = document.getElementById('commitOverlayTitle');

    const promptOverlay = document.getElementById('promptOverlay');
    const promptInput = document.getElementById('promptInput');
    const modelSelect = document.getElementById('modelSelect');

    const contextMenu = document.getElementById('contextMenu');

    const autosplitCheck = document.getElementById('autosplitCheck');

    // === Helpers ===
    function escapeHTML(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function getCheckedFiles() { return fileData.filter(f => f.checked); }
    function getCheckedCommits() { return commitData.filter(c => c.checked); }
    function getSelectedFiles() { return fileData.filter(f => f.selected); }
    function getSelectedCommits() { return commitData.filter(c => c.selected); }

    // === Render functions ===
    function renderFileList() {
      const query = fileFilterEl.value.toLowerCase().trim();
      const visible = query ? fileData.filter(f => f.path.toLowerCase().includes(query)) : fileData;

      fileCountEl.textContent = getCheckedFiles().length + ' Files';
      fileFilterClearEl.classList.toggle('show', query.length > 0);

      fileListEl.innerHTML = '';
      visible.forEach((f, i) => {
        const idx = fileData.indexOf(f);
        const el = document.createElement('div');
        el.className = 'file-item' + (f.selected ? ' active' : '');
        el.dataset.index = idx;

        // Parse delta to apply styling
        const deltaMatch = f.delta.match(/\+(\d+).*-(\d+)/);
        let deltaHtml = escapeHTML(f.delta);
        if (deltaMatch) {
          deltaHtml = `<span class="add">+${deltaMatch[1]}</span> <span class="rem">−${deltaMatch[2]}</span>`;
        }

        el.innerHTML = `
          <input type="checkbox" class="checkbox" data-action="check" ${f.checked ? 'checked' : ''} />
          <span class="file-path">${escapeHTML(f.path)}</span>
          <span class="file-changes">${deltaHtml}</span>
          <span class="file-status ${f.status}">${f.status}</span>
        `;
        el.addEventListener('click', e => onFileClick(e, idx));
        el.addEventListener('contextmenu', e => onFileContext(e, idx));
        fileListEl.appendChild(el);
      });

      updateGenerateBtn();
    }

    function renderCommitList() {
      if (!commitsVisible) {
        commitsSectionEl.style.display = 'none';
        return;
      }
      commitsSectionEl.style.display = 'flex';
      commitCountEl.textContent = getCheckedCommits().length + ' / ' + commitData.length;

      commitListEl.innerHTML = '';
      commitData.forEach((c, idx) => {
        const el = document.createElement('div');
        el.className = 'commit-item' + (c.selected ? ' active' : '');
        el.dataset.index = idx;

        // Parse subtitle to apply styling to + and - numbers
        let subtitleHtml = escapeHTML(c.subtitle);
        const subtitleMatch = c.subtitle.match(/\+(\d+).*-(\d+)/);
        if (subtitleMatch) {
          subtitleHtml = c.subtitle.replace(/\+(\d+).*-(\d+)/, (match, add, del) => {
            return `· <span class="add">+${add}</span> · <span class="rem">−${del}</span>`;
          });
        }

        el.innerHTML = `
          <input type="checkbox" class="checkbox" data-action="check" ${c.checked ? 'checked' : ''} />
          <div class="commit-info">
            <div class="commit-title">${escapeHTML(c.title)}</div>
            <div class="commit-subtitle">${subtitleHtml}</div>
          </div>
        `;
        el.addEventListener('click', e => onCommitClick(e, idx));
        commitListEl.appendChild(el);
      });

      updateCommitBtn();
    }

    function renderDetails() {
      const selFiles = getSelectedFiles();
      const selCommits = getSelectedCommits();

      placeholder.style.display = 'none';
      fileView.classList.remove('active');
      commitView.classList.remove('active');

      if (selFiles.length === 1 && selCommits.length === 0) {
        const f = selFiles[0];
        fileView.classList.add('active');
        codePath.textContent = f.path;
        codeMeta.textContent = f.delta;
        const lines = fileContents[f.id] || ['No preview available for ' + f.path];
        codeContent.innerHTML = lines.map((line, i) => {
          return '<span class="ln">' + String(i+1).padStart(2,' ') + '</span>' + escapeHTML(line);
        }).join('\n');
      } else if (selCommits.length === 1 && selFiles.length === 0) {
        const c = selCommits[0];
        commitView.classList.add('active');
        titleInput.value = c.title;
        bodyInput.value = c.body;
        updateCharCount();
        renderFileDrawer(c);
      } else if (selFiles.length > 1) {
        placeholder.style.display = 'flex';
        placeholder.querySelector('.title').textContent = selFiles.length + ' files selected';
        placeholder.querySelector('.desc').textContent = selFiles.filter(f=>f.checked).length + ' of ' + selFiles.length + ' checked.\nRight-click for bulk actions.';
      } else if (selCommits.length > 1) {
        placeholder.style.display = 'flex';
        placeholder.querySelector('.title').textContent = selCommits.length + ' commits selected';
        placeholder.querySelector('.desc').textContent = 'Select a single commit to edit.';
      } else {
        placeholder.style.display = 'flex';
        placeholder.querySelector('.title').textContent = 'Nothing selected';
        placeholder.querySelector('.desc').textContent = 'Select a file on the left to inspect details.';
      }
    }

    function renderFileDrawer(c) {
      const fileGrid = document.getElementById('fileGrid');
      fileGrid.innerHTML = '';
      let add = 0, del = 0;

      c.files.forEach(fid => {
        const f = fileData.find(x => x.id === fid);
        if (!f) return;
        const m = f.delta.match(/\+(\d+).*-(\d+)/);
        if (m) { add += +m[1]; del += +m[2]; }

        const item = document.createElement('div');
        item.className = 'file-item';
        item.innerHTML = `
          <span class="file-status ${f.status}">${f.status}</span>
          <span class="file-path">${escapeHTML(f.path)}</span>
          <span class="file-changes"><span class="add">+${m?m[1]:0}</span> <span class="rem">−${m?m[2]:0}</span></span>
        `;
        fileGrid.appendChild(item);
      });

      document.getElementById('fileCountStats').textContent = c.files.length + ' files';
      document.getElementById('insertionStats').textContent = '+' + add + ' insertions';
      document.getElementById('deletionStats').textContent = '−' + del + ' deletions';
    }

    function updateCharCount() {
      const tLen = titleInput.value.length;
      const bLen = bodyInput.value.length;
      titleCount.textContent = tLen + ' chars';
      titleCount.classList.remove('warning', 'danger');
      if (tLen > 72) titleCount.classList.add('danger');
      else if (tLen > 50) titleCount.classList.add('warning');
      bodyCount.textContent = bLen + ' chars';
    }

    function updateGenerateBtn() {
      const enabled = getCheckedFiles().length > 0;
      btnGenerate.disabled = !enabled;
      btnGenerateMenuToggle.disabled = !enabled;
    }

    function updateCommitBtn() {
      const enabled = commitsVisible && getCheckedCommits().length > 0;
      btnCommit.disabled = !enabled;
      btnCommitMenuToggle.disabled = !enabled;
    }

    // === Event handlers ===
    function onFileClick(e, idx) {
      if (e.target.closest('[data-action="check"]')) {
        fileData[idx].checked = !fileData[idx].checked;
        renderFileList();
        renderDetails();
        return;
      }
      commitData.forEach(c => c.selected = false);
      if (e.shiftKey && lastFileIndex !== null) {
        const a = Math.min(lastFileIndex, idx), b = Math.max(lastFileIndex, idx);
        fileData.forEach((f, i) => f.selected = i >= a && i <= b);
      } else if (e.metaKey || e.ctrlKey) {
        fileData[idx].selected = !fileData[idx].selected;
      } else {
        fileData.forEach(f => f.selected = false);
        fileData[idx].selected = true;
      }
      lastFileIndex = idx;
      renderFileList();
      renderCommitList();
      renderDetails();
    }

    function onCommitClick(e, idx) {
      if (e.target.closest('[data-action="check"]')) {
        commitData[idx].checked = !commitData[idx].checked;
        renderCommitList();
        return;
      }
      fileData.forEach(f => f.selected = false);
      if (e.shiftKey && lastCommitIndex !== null) {
        const a = Math.min(lastCommitIndex, idx), b = Math.max(lastCommitIndex, idx);
        commitData.forEach((c, i) => c.selected = i >= a && i <= b);
      } else if (e.metaKey || e.ctrlKey) {
        commitData[idx].selected = !commitData[idx].selected;
      } else {
        commitData.forEach(c => c.selected = false);
        commitData[idx].selected = true;
      }
      lastCommitIndex = idx;
      renderFileList();
      renderCommitList();
      renderDetails();
    }

    function onFileContext(e, idx) {
      e.preventDefault();
      if (!fileData[idx].selected) {
        fileData.forEach(f => f.selected = false);
        fileData[idx].selected = true;
        renderFileList();
        renderDetails();
      }
      contextMenu.style.left = e.clientX + 'px';
      contextMenu.style.top = e.clientY + 'px';
      contextMenu.classList.add('show');
    }

    // === Branch dropdown ===
    function renderBranchList() {
      const q = branchFilter.value.toLowerCase().trim();
      const filtered = q ? branches.filter(b => b.toLowerCase().includes(q)) : branches;
      branchFilterClear.classList.toggle('show', q.length > 0);
      branchCountEl.textContent = filtered.length;

      branchList.innerHTML = '';
      filtered.forEach(b => {
        const el = document.createElement('div');
        el.className = 'dropdown-item' + (b === currentBranch ? ' selected' : '');
        el.innerHTML = '<span>' + escapeHTML(b) + '</span>' + (b === currentBranch ? '<span class="branch-current-indicator">current</span>' : '');
        el.addEventListener('click', () => {
          currentBranch = b;
          branchLabel.textContent = b;
          branchDropdown.classList.remove('show');
        });
        branchList.appendChild(el);
      });
    }

    btnBranch.addEventListener('click', e => {
      e.stopPropagation();
      branchDropdown.classList.toggle('show');
      if (branchDropdown.classList.contains('show')) {
        renderBranchList();
        branchFilter.focus();
      }
    });
    branchFilter.addEventListener('input', renderBranchList);
    branchFilterClear.addEventListener('click', () => { branchFilter.value = ''; renderBranchList(); branchFilter.focus(); });

    // === Generate menu ===
    btnGenerateMenuToggle.addEventListener('click', e => {
      e.stopPropagation();
      if (!btnGenerateMenuToggle.disabled) generateMenu.classList.toggle('show');
    });
    btnGenerate.addEventListener('click', () => { if (!btnGenerate.disabled) runGenerate(); });
    document.getElementById('miGenerate').addEventListener('click', () => { generateMenu.classList.remove('show'); runGenerate(); });
    document.getElementById('miGeneratePrompt').addEventListener('click', () => { generateMenu.classList.remove('show'); promptOverlay.classList.add('show'); promptInput.focus(); });

    // === Commit menu ===
    btnCommitMenuToggle.addEventListener('click', e => {
      e.stopPropagation();
      if (!btnCommitMenuToggle.disabled) commitMenu.classList.toggle('show');
    });
    btnCommit.addEventListener('click', () => { if (!btnCommit.disabled) runCommit('commit'); });
    document.getElementById('miCommit').addEventListener('click', () => { commitMenu.classList.remove('show'); runCommit('commit'); });
    document.getElementById('miCommitPush').addEventListener('click', () => { commitMenu.classList.remove('show'); runCommit('commitPush'); });

    // === Prompt overlay ===
    document.getElementById('promptCancel').addEventListener('click', () => promptOverlay.classList.remove('show'));
    document.getElementById('promptClose').addEventListener('click', () => promptOverlay.classList.remove('show'));
    document.getElementById('promptGenerate').addEventListener('click', () => { promptOverlay.classList.remove('show'); runGenerate(); });

    // === Context menu actions ===
    document.getElementById('ctxCopyPath').addEventListener('click', () => {
      const paths = getSelectedFiles().map(f => f.path).join('\n');
      navigator.clipboard.writeText(paths);
      contextMenu.classList.remove('show');
    });
    document.getElementById('ctxOpenBrowser').addEventListener('click', () => {
      console.log('Open in browser:', getSelectedFiles().map(f => f.path));
      contextMenu.classList.remove('show');
    });
    document.getElementById('ctxCheckAll').addEventListener('click', () => { fileData.forEach(f => f.checked = true); renderFileList(); contextMenu.classList.remove('show'); });
    document.getElementById('ctxUncheckAll').addEventListener('click', () => { fileData.forEach(f => f.checked = false); renderFileList(); contextMenu.classList.remove('show'); });
    document.getElementById('ctxCheckSelected').addEventListener('click', () => { fileData.forEach(f => { if (f.selected) f.checked = true; }); renderFileList(); contextMenu.classList.remove('show'); });
    document.getElementById('ctxUncheckSelected').addEventListener('click', () => { fileData.forEach(f => { if (f.selected) f.checked = false; }); renderFileList(); contextMenu.classList.remove('show'); });

    // === File filter ===
    fileFilterEl.addEventListener('input', renderFileList);
    fileFilterClearEl.addEventListener('click', () => { fileFilterEl.value = ''; renderFileList(); fileFilterEl.focus(); });

    // === Title/body input ===
    titleInput.addEventListener('input', () => {
      const sel = getSelectedCommits();
      if (sel.length === 1) sel[0].title = titleInput.value;
      updateCharCount();
    });
    bodyInput.addEventListener('input', () => {
      const sel = getSelectedCommits();
      if (sel.length === 1) sel[0].body = bodyInput.value;
      updateCharCount();
    });

    // === Progress animations ===
    const genSubSteps = [
      ['Reading file metadata...', 'Computing differences...', 'Parsing changes...', 'Analyzing code...'],
      ['Loading file list...', 'Extracting key changes...', 'Identifying patterns...', 'Generating summary...'],
      ['Formatting message...', 'Adding context...', 'Including scope...', 'Finalizing format...'],
      ['Validating metadata...', 'Checking permissions...', 'Preparing payload...', 'Ready to commit...']
    ];

    const commitSubSteps = [
      ['Collecting metadata...', 'Validating inputs...', 'Building request...', 'Verifying permissions...'],
      ['Hashing tree objects...', 'Writing blob objects...', 'Creating tree...', 'Writing commit object...'],
      ['Updating HEAD...', 'Writing refs...', 'Syncing index...', 'Verifying integrity...'],
      ['Commit created!', 'All checks passed', 'Ready for push', 'Done']
    ];

    async function runProgress(overlay, counter, stepsEl, subSteps) {
      overlay.classList.add('show');
      const steps = stepsEl.querySelectorAll('.step');
      for (let i = 0; i < steps.length; i++) {
        const step = steps[i];
        const status = step.querySelector('.step-status');
        const indicator = step.querySelector('.step-indicator');
        step.classList.add('active');
        indicator.innerHTML = '<div class="step-spinner"></div>';
        counter.textContent = i + '/' + steps.length;
        for (const sub of subSteps[i]) {
          status.textContent = sub;
          await new Promise(r => setTimeout(r, 100 + Math.random() * 200));
        }
        step.classList.remove('active');
        step.classList.add('done');
        status.textContent = 'done';
        indicator.innerHTML = '✓';
        counter.textContent = (i+1) + '/' + steps.length;
      }
      await new Promise(r => setTimeout(r, 300));
      overlay.classList.remove('show');
      steps.forEach(s => {
        s.classList.remove('active', 'done');
        s.querySelector('.step-status').textContent = 'queue';
        s.querySelector('.step-indicator').innerHTML = '';
      });
    }

    async function runGenerate() {
      await runProgress(generateOverlay, genCounter, document.getElementById('generateSteps'), genSubSteps);
      commitsVisible = true;
      commitData.forEach(c => c.checked = true);
      fileData.forEach(f => f.selected = false);
      if (commitData.length > 0) commitData[0].selected = true;
      renderFileList();
      renderCommitList();
      renderDetails();
    }

    async function runCommit(mode) {
      commitOverlayTitle.textContent = mode === 'commitPush' ? 'Committing & pushing' : 'Committing changes';
      await runProgress(commitOverlay, commitCounter, document.getElementById('commitSteps'), commitSubSteps);
    }

    // === Global click to close menus ===
    document.addEventListener('click', () => {
      branchDropdown.classList.remove('show');
      generateMenu.classList.remove('show');
      commitMenu.classList.remove('show');
      contextMenu.classList.remove('show');
    });

    // === Keyboard shortcuts ===
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        branchDropdown.classList.remove('show');
        generateMenu.classList.remove('show');
        commitMenu.classList.remove('show');
        contextMenu.classList.remove('show');
        generateOverlay.classList.remove('show');
        commitOverlay.classList.remove('show');
        promptOverlay.classList.remove('show');
      }
      if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'g' && !e.shiftKey) {
        e.preventDefault();
        if (!btnGenerate.disabled) runGenerate();
      }
      if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key.toLowerCase() === 'g') {
        e.preventDefault();
        if (!btnGenerate.disabled) { promptOverlay.classList.add('show'); promptInput.focus(); }
      }
    });

    // === Init ===
    fileData[0].selected = true;
    renderFileList();
    renderCommitList();
    renderDetails();
    renderBranchList();
  </script>
</body>
</html>
